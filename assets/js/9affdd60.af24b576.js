"use strict";(globalThis.webpackChunkhome=globalThis.webpackChunkhome||[]).push([[7131],{424(e){e.exports=JSON.parse('{"permalink":"/blog/2022/11/21/golang-memory-dump","source":"@site/blog/2022-11-21-golang-memory-dump.md","title":"Profiling Go in Kubernetes","description":"Profiling Go in Kubernetes using Kubernetes debug.","date":"2022-11-21T00:00:00.000Z","tags":[{"inline":true,"label":"pprof","permalink":"/blog/tags/pprof"},{"inline":true,"label":"kubernetes","permalink":"/blog/tags/kubernetes"},{"inline":true,"label":"debug","permalink":"/blog/tags/debug"}],"readingTime":6.16,"hasTruncateMarker":true,"authors":[{"name":"Edvin Norling","title":"Expert DevOps Engineer","url":"https://github.com/nissessenap","email":"edvin.norling@xenit.se","imageURL":"https://media-exp1.licdn.com/dms/image/C5603AQEtMiyg5yOAqQ/profile-displayphoto-shrink_800_800/0/1580133585786?e=1673481600&v=beta&t=SXFrHWYPkM2jpaKESqhdVIQix65MQP1slsoTBXGOmrY","key":"nissessenap","page":null}],"frontMatter":{"title":"Profiling Go in Kubernetes","description":"Profiling Go in Kubernetes using Kubernetes debug.","authors":"nissessenap","tags":["pprof","kubernetes","debug"],"keywords":["pprof","kubernetes","debug"]},"unlisted":false,"nextItem":{"title":"Improving XKS security using Starboard","permalink":"/blog/2022/05/04/starboard"}}')},8453(e,n,t){t.d(n,{R:()=>l,x:()=>s});var o=t(6540);const a={},i=o.createContext(a);function l(e){const n=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),o.createElement(i.Provider,{value:n},e.children)}},8471(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var o=t(424),a=t(4848),i=t(8453),l=t(8180);const s={title:"Profiling Go in Kubernetes",description:"Profiling Go in Kubernetes using Kubernetes debug.",authors:"nissessenap",tags:["pprof","kubernetes","debug"],keywords:["pprof","kubernetes","debug"]},r=void 0,c={authorsImageUrls:[void 0]},p=[{value:"Application",id:"application",level:2},{value:"Debug container/ephemeral container",id:"debug-containerephemeral-container",level:2},{value:"Cleanup",id:"cleanup",level:2},{value:"Conclusion",id:"conclusion",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"In Kubernetes 1.23 the new ephemeral containers API went in to beta and in 1.25 it became stable.\nEphemeral containers or debug containers as it is also known as, makes it's possible to inject a container into an already running pod without restarting it.\nThis is very useful when you want to debug your application since the ephemeral container can provide tools that you don't want in your application container."}),"\n",(0,a.jsx)(n.p,{children:"In this post I thought we could go trough how to profile a running container in Kubernetes."}),"\n",(0,a.jsx)(n.h2,{id:"application",children:"Application"}),"\n",(0,a.jsxs)(n.p,{children:["To get started lets use a very simple test ",(0,a.jsx)(n.a,{href:"https://github.com/polarsignals/pprof-example-app-go",children:"application"})," written by the team over at ",(0,a.jsx)(n.a,{href:"https://www.polarsignals.com/",children:"Polar Signals"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"They have been kind enough to publish a container image and a Kubernetes deployment that we will use.\nThe application is built in such a way that it will continue to use memory and the Kubernetes yaml don't contain any request nor limit so don't run this for a long time or your system will probably OOM."}),"\n",(0,a.jsx)(n.p,{children:"Run the application on Kubernetes 1.23 or higher."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f https://raw.githubusercontent.com/polarsignals/pprof-example-app-go/main/manifests/deployment.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"For starters lets have a look at the pprof http endpoint using curl.\nA simple way of doing so is to create a Kubernetes service and reach the pod from another container."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# Expose the pprof deployment\nkubectl expose deployment pprof-example-app-go --port=8080\n"})}),"\n",(0,a.jsx)(n.p,{children:"Create a curl pod and look at the data inside our app."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl run -i -t curl --image=curlimages/curl:latest /bin/sh\n"})}),"\n",(0,a.jsx)(n.p,{children:"You will be sent directly in to the container and you can run something like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"curl http://pprof-example-app-go:8080/debug/pprof/allocs?debug=1\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will show you an output that look something like this:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"heap profile: 4: 47357952 [5473: 554303632] @ heap/1048576\n1: 46882816 [1: 46882816] @ 0x697585 0x470ce1\n#\t0x697584\tmain.allocMem+0xa4\t/home/brancz/src/github.com/polarsignals/pprof-example-app-go/main.go:65\n\n1: 212992 [1: 212992] @ 0x4e3b6e 0x4e3e6c 0x6974c5 0x470ce1\n#\t0x4e3b6d\tlog.(*Logger).Output+0x38d\t/usr/local/go/src/log/log.go:180\n#\t0x4e3e6b\tlog.Println+0x6b\t\t/usr/local/go/src/log/log.go:329\n#\t0x6974c4\tmain.calculateFib+0xc4\t\t/home/brancz/src/github.com/polarsignals/pprof-example-app-go/main.go:55\n\n1: 204800 [1: 204800] @ 0x4fb68f 0x4fb256 0x503d3d 0x502c97 0x4f6d5e 0x4f6c92 0x4d22a5 0x4d2625 0x4d70b1 0x4cf3d2 0x4e3e3f 0x6974c5 0x470ce1\n#\t0x4fb68e\tmath/big.nat.make+0x5ee\t\t/usr/local/go/src/math/big/nat.go:69\n#\t0x4fb255\tmath/big.nat.sqr+0x1b5\t\t/usr/local/go/src/math/big/nat.go:595\n"})}),"\n",(0,a.jsx)(n.p,{children:"Sadly this output isn't the easiest to read so why not use pprof and while we are at it why not use ephemeral containers."}),"\n",(0,a.jsx)(n.h2,{id:"debug-containerephemeral-container",children:"Debug container/ephemeral container"}),"\n",(0,a.jsx)(n.p,{children:"My original plan for this blog post was to attach a new volume to the ephemeral container so we could save data locally and then copy it out to our client and show some nice flame graphs. But apparently it's not supported to attach volumes to the ephemeral container.\nThe ephemeral container cannot even reach the existing volumes on the pod you attach to."}),"\n",(0,a.jsxs)(n.p,{children:["There is an open ",(0,a.jsx)(n.a,{href:"https://github.com/kubernetes/kubectl/issues/1071",children:"issue"})," to solve this but it's not part of the current enhancement ",(0,a.jsx)(n.a,{href:"https://github.com/kubernetes/enhancements/issues/1441",children:"proposal"})," so this is nothing that we will see in the near future."]}),"\n",(0,a.jsx)(n.p,{children:"So instead I will just show how we can debug using pprof from within the container.\nSince we exposed the endpoint through a service we could of course do this from another pod as well.\nBut in general you should be very restrictive of what traffic that can reach your pprof endpoint if you expose it at all."}),"\n",(0,a.jsxs)(n.p,{children:["So finally time to use the ",(0,a.jsx)(n.code,{children:"kubectl debug"})," command."]}),"\n",(0,a.jsxs)(n.p,{children:["The debug command is used on a specific pod, in my case it's ",(0,a.jsx)(n.code,{children:"pprof-example-app-go-7c4b6d77d-xw52p"}),".\nLet's attach a standard golang container to our running pod, in this case i choose golang 1.15 to match the pprof tool with the running application."]}),"\n",(0,a.jsx)(n.p,{children:"Kubernetes will attach the container for you and give you a shell."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl debug -i -t pprof-example-app-go-7c4b6d77d-xw52p --image=golang:1.15-alpine3.14 -- /bin/sh\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now we can point on localhost using pprof."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"go tool pprof http://localhost:8080/debug/pprof/allocs\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will provide you with a pprof terminal inside the container."}),"\n",(0,a.jsxs)(n.p,{children:["I'm no pprof pro but there are some easy commands to get you started.\n",(0,a.jsx)(n.code,{children:"top 10 -cum"})," will show you the resource consumption it takes to call a function including all function it calls"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pprof",children:"top 10 -cum\nShowing nodes accounting for 27.63GB, 99.80% of 27.69GB total\nDropped 26 nodes (cum <= 0.14GB)\nShowing top 10 nodes out of 17\n      flat  flat%   sum%        cum   cum%\n         0     0%     0%    25.66GB 92.69%  main.calculateFib\n   25.59GB 92.43% 92.43%    25.59GB 92.43%  math/big.nat.make (inline)\n         0     0% 92.43%    25.41GB 91.78%  github.com/polarsignals/pprof-example-app-go/fib.Fibonacci\n         0     0% 92.43%    25.41GB 91.78%  math/big.(*Int).Add\n         0     0% 92.43%    25.41GB 91.78%  math/big.nat.add\n    2.02GB  7.30% 99.73%     2.02GB  7.30%  main.allocMem\n    0.02GB 0.073% 99.80%     0.25GB  0.91%  fmt.Sprintln\n         0     0% 99.80%     0.25GB  0.91%  log.Println\n         0     0% 99.80%     0.23GB  0.84%  fmt.(*pp).doPrintln\n         0     0% 99.80%     0.23GB  0.84%  fmt.(*pp).handleMethods\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"top 10 -flat"})," will show you the resource consumption it takes to call a function excluding all function it calls"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pprof",children:"Active filters:\n   ignore=flat\nShowing nodes accounting for 27.66GB, 99.90% of 27.69GB total\nDropped 10 nodes (cum <= 0.14GB)\nShowing top 10 nodes out of 17\n      flat  flat%   sum%        cum   cum%\n   25.59GB 92.43% 92.43%    25.59GB 92.43%  math/big.nat.make (inline)\n    2.02GB  7.30% 99.73%     2.02GB  7.30%  main.allocMem\n    0.03GB   0.1% 99.83%     0.21GB  0.76%  math/big.nat.itoa\n    0.02GB 0.073% 99.90%     0.25GB  0.91%  fmt.Sprintln\n         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).doPrintln\n         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).handleMethods\n         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).printArg\n         0     0% 99.90%    25.41GB 91.78%  github.com/polarsignals/pprof-example-app-go/fib.Fibonacci\n         0     0% 99.90%     0.25GB  0.91%  log.Println\n         0     0% 99.90%    25.66GB 92.69%  main.calculateFib\n"})}),"\n",(0,a.jsxs)(n.p,{children:["By looking at the output we can see that it's ",(0,a.jsx)(n.code,{children:"math/big.nat.make"})," that takes the most resources."]}),"\n",(0,a.jsx)(n.p,{children:"Just for fun I also generated a flame graph using pprof by port-forwarding to the application and running"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"go tool pprof -http=: http://localhost:8080/debug/pprof/allocs\n"})}),"\n",(0,a.jsx)("img",{alt:"pprof flame",src:(0,l.Ay)("img/assets/blog/pprof_flame.png")}),"\n",(0,a.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,a.jsx)(n.p,{children:"To cleanup the resources we created run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl delete -f https://raw.githubusercontent.com/polarsignals/pprof-example-app-go/main/manifests/deployment.yaml\nkubectl delete svc pprof-example-app-go\nkubectl delete pod curl\n"})}),"\n",(0,a.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"kubectl debug"})," command is extremely useful when you want to debug your application and you\ndon't have access to a shell or the tools that you need in your normal container."]}),"\n",(0,a.jsxs)(n.p,{children:["It saves us from having to install unneeded applications in our container which lowers the amount of potential CVE",":s"," and the time it takes to start your container by lower container size.\nKubectl debug isn't perfect and it won't work for all your uses cases especially since you can't use it to interact with existing volumes but it's a great start."]}),"\n",(0,a.jsxs)(n.p,{children:["When it comes to continues profiling it's probably better to look at tool specifically written for it like ",(0,a.jsx)(n.a,{href:"https://grafana.com/oss/phlare/",children:"Grafana Phlare"})," or ",(0,a.jsx)(n.a,{href:"https://www.parca.dev/docs/overview",children:"Parca"}),".\nBut using a tool like pprof locally can be a good start. Hopefully we will get time to write a blog about continues profiling in the future."]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}}}]);