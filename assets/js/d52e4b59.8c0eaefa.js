"use strict";(globalThis.webpackChunkhome=globalThis.webpackChunkhome||[]).push([[9109],{2873(e,i,t){t.r(i),t.d(i,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>l,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"xks/developer-guide/ci-cd/cd","title":"Continuous Delivery","description":"Continuous Delivery (CD) should be the only way to make changes to running applications in the XKS service.","source":"@site/docs/xks/developer-guide/ci-cd/cd.md","sourceDirName":"xks/developer-guide/ci-cd","slug":"/xks/developer-guide/ci-cd/cd","permalink":"/docs/xks/developer-guide/ci-cd/cd","draft":false,"unlisted":false,"editUrl":"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/developer-guide/ci-cd/cd.md","tags":[],"version":"current","frontMatter":{"id":"cd","title":"Continuous Delivery"},"sidebar":"docs","previous":{"title":"Continuous Integration","permalink":"/docs/xks/developer-guide/ci-cd/ci"},"next":{"title":"GitOps a la XKS","permalink":"/docs/xks/developer-guide/ci-cd/gitops"}}');var s=t(4848),o=t(8453),r=t(8180);const l={id:"cd",title:"Continuous Delivery"},a=void 0,c={},d=[{value:"GitOps",id:"gitops",level:2},{value:"Azure AD Identity",id:"azure-ad-identity",level:2},{value:"GitOps Setup",id:"gitops-setup",level:2},{value:"Validation for GitOps Status",id:"validation-for-gitops-status",level:3},{value:"Setup CI/CD pipeline",id:"setup-cicd-pipeline",level:2},{value:"Enable CI user to push to gitops repo",id:"enable-ci-user-to-push-to-gitops-repo",level:3},{value:"Service connections",id:"service-connections",level:3}];function u(e){const i={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.p,{children:"Continuous Delivery (CD) should be the only way to make changes to running applications in the XKS service.\nThis is to ensure that changes are consistent and tracked in a centralized manner that can be observed by all."}),"\n",(0,s.jsx)(i.h2,{id:"gitops",children:"GitOps"}),"\n",(0,s.jsx)(i.h2,{id:"azure-ad-identity",children:"Azure AD Identity"}),"\n",(0,s.jsx)(i.h2,{id:"gitops-setup",children:"GitOps Setup"}),"\n",(0,s.jsx)(i.h3,{id:"validation-for-gitops-status",children:"Validation for GitOps Status"}),"\n",(0,s.jsx)(i.p,{children:"Important to remember is to setup the Build Validation for the Status pipeline to trigger correctly."}),"\n",(0,s.jsx)(i.p,{children:"That is done:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"In Azure devops"}),"\n",(0,s.jsx)(i.li,{children:"Project Settings -> Repositories -> 'your-gitops-repo' -> On the 'Policies' tab"}),"\n",(0,s.jsx)(i.li,{children:"Select your default branch, usually 'main'. And on the 'Build Validation' section, press the '+' button."}),"\n",(0,s.jsx)(i.li,{children:"Select your Status pipeline"}),"\n",(0,s.jsx)(i.li,{children:"Enter the following settings:"}),"\n",(0,s.jsx)(i.li,{children:"Trigger: Automatic"}),"\n",(0,s.jsx)(i.li,{children:"Policy requirement: Required"}),"\n",(0,s.jsx)(i.li,{children:"Build expiration: 12h"}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"Also see images below:"}),"\n",(0,s.jsx)("img",{alt:"build-validation",src:(0,r.Ay)("img/assets/xks/developer-guide/build-validation.png")}),"\n",(0,s.jsx)("img",{alt:"build-validation-setup",src:(0,r.Ay)("img/assets/xks/developer-guide/build-validation-setup.png")}),"\n",(0,s.jsx)("img",{alt:"build-validation-final",src:(0,r.Ay)("img/assets/xks/developer-guide/build-validation-final.png")}),"\n",(0,s.jsx)(i.h2,{id:"setup-cicd-pipeline",children:"Setup CI/CD pipeline"}),"\n",(0,s.jsxs)(i.p,{children:["At Xenit we have created a CI/CD template to make it easier to get started with GitOps in our case using FluxV2 and the ",(0,s.jsx)(i.a,{href:"https://toolkit.fluxcd.io/",children:"GitOps toolkit"}),"."]}),"\n",(0,s.jsxs)(i.p,{children:["You can find the base for all our Azure DevOps pipelines in our ",(0,s.jsx)(i.a,{href:"https://github.com/XenitAB/azure-devops-templates/tree/main/gitops-v2",children:"Azure Devops Templates repo"}),"."]}),"\n",(0,s.jsx)(i.p,{children:"Follow the example documentation on how to setup your base repo.\nBelow we will explain how to do the manual steps that is needed to get Azure DevOps to enable some of the flows that we are creating."}),"\n",(0,s.jsx)(i.h3,{id:"enable-ci-user-to-push-to-gitops-repo",children:"Enable CI user to push to gitops repo"}),"\n",(0,s.jsx)(i.p,{children:"The core feature of the gitops repo is that one of the pipelines automatically updates the image tag in your repository so Flux will automatically update your deployment in Kubernetes."}),"\n",(0,s.jsx)(i.p,{children:"We have to grant it permissions to do this, sadly manually..."}),"\n",(0,s.jsxs)(i.p,{children:['In cases where there are multiple "build services" make sure that you are setting correct permissons the correct one. This appears to be a trial-and-error based mission. Use the ',(0,s.jsx)(i.code,{children:"Project Collection Build Service ({your organization})"}),", not the group ",(0,s.jsx)(i.code,{children:"Project Collection Build Service Accounts ({your organization})"}),"."]}),"\n",(0,s.jsx)("img",{alt:"CI access",src:(0,r.Ay)("img/assets/xks/developer-guide/gitops_repo_settings.png")}),"\n",(0,s.jsx)(i.h3,{id:"service-connections",children:"Service connections"}),"\n",(0,s.jsx)(i.p,{children:"To be able to talk from Azure DevOps to AKS using our gitops pipelines we also need to configure service connections to tenant namespace.\nSadly setting up the Service Connections is a manual step."}),"\n",(0,s.jsx)(i.p,{children:"Get the needed config."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-shell",children:'az keyvault secret show --vault-name <vault-name> --name <secret-name> -o tsv --query value\n# Example\naz keyvault secret show --vault-name kv-prod-we-core-1337 --name sp-rg-xks-prod-backend-contributor -o tsv --query value\n\n# The output will look something like this\n{"clientId":"12345","clientSecret":"SoMuchSecret","subscriptionId":"sub-id","tenantId":"tenant-id"}\n'})}),"\n",(0,s.jsx)(i.p,{children:"In Azure DevOps:\nProject settings -> Service connections -> New service connection -> Azure Resource Manager -> Service principal (manual)"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Subscription Id = subscriptionId"}),"\n",(0,s.jsx)(i.li,{children:"Service Principal Id = clientId"}),"\n",(0,s.jsx)(i.li,{children:"Service principal key = clientSecret"}),"\n",(0,s.jsx)(i.li,{children:"Tenant ID = tenantId"}),"\n",(0,s.jsx)(i.li,{children:"Service connection name = random-name"}),"\n"]})]})}function p(e={}){const{wrapper:i}={...(0,o.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453(e,i,t){t.d(i,{R:()=>r,x:()=>l});var n=t(6540);const s={},o=n.createContext(s);function r(e){const i=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),n.createElement(o.Provider,{value:i},e.children)}}}]);