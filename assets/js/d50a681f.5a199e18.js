"use strict";(globalThis.webpackChunkhome=globalThis.webpackChunkhome||[]).push([[5216],{6284(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"xks/operator-guide/ingress-nginx deprecation/azure-dns-migration-playbook","title":"Azure DNS Migration Playbook","description":"This playbook provides a step-by-step process for migrating from Ingress to Gateway API when using Azure DNS with external-dns. This approach ensures zero-downtime DNS switchover.","source":"@site/docs/xks/operator-guide/ingress-nginx deprecation/azure-dns-migration-playbook.md","sourceDirName":"xks/operator-guide/ingress-nginx deprecation","slug":"/xks/operator-guide/ingress-nginx deprecation/azure-dns-migration-playbook","permalink":"/docs/xks/operator-guide/ingress-nginx deprecation/azure-dns-migration-playbook","draft":false,"unlisted":false,"editUrl":"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/ingress-nginx deprecation/azure-dns-migration-playbook.md","tags":[],"version":"current","frontMatter":{"id":"azure-dns-migration-playbook","title":"Azure DNS Migration Playbook"},"sidebar":"docs","previous":{"title":"Envoy Gateway","permalink":"/docs/xks/operator-guide/ingress-nginx deprecation/envoy-gateway"},"next":{"title":"Containers","permalink":"/docs/xenit-style-guide/containers"}}');var a=t(4848),r=t(8453);const i={id:"azure-dns-migration-playbook",title:"Azure DNS Migration Playbook"},o=void 0,l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Migration Steps",id:"migration-steps",level:2},{value:"Step 1: Lower DNS TTL",id:"step-1-lower-dns-ttl",level:3},{value:"Step 2: Create HTTPRoutes with Gateway Hostname",id:"step-2-create-httproutes-with-gateway-hostname",level:3},{value:"Step 3: Add Original Hostname to HTTPRoute",id:"step-3-add-original-hostname-to-httproute",level:3},{value:"Step 4: Update Ingress with Target Annotation",id:"step-4-update-ingress-with-target-annotation",level:3},{value:"Step 5: Wait for DNS Propagation",id:"step-5-wait-for-dns-propagation",level:3},{value:"Step 6: Remove Ingress Resources",id:"step-6-remove-ingress-resources",level:3},{value:"Step 7: Update TXT Record Ownership",id:"step-7-update-txt-record-ownership",level:3},{value:"Step 8 (Optional): Clean Up HTTPRoute Hostnames",id:"step-8-optional-clean-up-httproute-hostnames",level:3},{value:"Summary Checklist",id:"summary-checklist",level:2},{value:"Rollback Procedure",id:"rollback-procedure",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"This playbook provides a step-by-step process for migrating from Ingress to Gateway API when using Azure DNS with external-dns. This approach ensures zero-downtime DNS switchover."}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Access to Azure DNS zone management"}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"kubectl"})," access to the cluster"]}),"\n",(0,a.jsx)(n.li,{children:"Understanding of your current Ingress resources"}),"\n",(0,a.jsx)(n.li,{children:"Gateway API and Envoy Gateway already deployed in the cluster"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"migration-steps",children:"Migration Steps"}),"\n",(0,a.jsx)(n.h3,{id:"step-1-lower-dns-ttl",children:"Step 1: Lower DNS TTL"}),"\n",(0,a.jsx)(n.p,{children:"Edit the TTL for all existing Ingress A records to 5 seconds in Azure DNS. This ensures DNS changes propagate quickly during the migration."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# List current DNS records and their TTLs\naz network dns record-set a list \\\n  --resource-group <dns-resource-group> \\\n  --zone-name <your-domain.com> \\\n  --output table\n\n# Update TTL for a specific record\naz network dns record-set a update \\\n  --resource-group <dns-resource-group> \\\n  --zone-name <your-domain.com> \\\n  --name <record-name> \\\n  --set ttl=5\n"})}),"\n",(0,a.jsx)(n.admonition,{title:"Important",type:"warning",children:(0,a.jsx)(n.p,{children:"Before proceeding to the next steps, wait for the previous TTL to expire. If the original TTL was 300 seconds (5 minutes), wait at least 5 minutes before continuing."})}),"\n",(0,a.jsx)(n.h3,{id:"step-2-create-httproutes-with-gateway-hostname",children:"Step 2: Create HTTPRoutes with Gateway Hostname"}),"\n",(0,a.jsxs)(n.p,{children:["Create HTTPRoutes for each application that has an Ingress. Use a new hostname with a ",(0,a.jsx)(n.code,{children:"gw-"})," prefix."]}),"\n",(0,a.jsx)(n.admonition,{title:"Hostname Format",type:"note",children:(0,a.jsxs)(n.p,{children:["The prefix must use a dash (",(0,a.jsx)(n.code,{children:"-"}),"), not a dot (",(0,a.jsx)(n.code,{children:"."}),"). Using ",(0,a.jsx)(n.code,{children:"gw.app.example.com"})," would create a subdomain, while ",(0,a.jsx)(n.code,{children:"gw-app.example.com"})," is a different hostname in the same zone."]})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Example:"})," If your Ingress uses ",(0,a.jsx)(n.code,{children:"app.example.com"}),", create an HTTPRoute with ",(0,a.jsx)(n.code,{children:"gw-app.example.com"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: gateway.networking.k8s.io/v1\nkind: HTTPRoute\nmetadata:\n  name: example-app\n  namespace: tenant\nspec:\n  parentRefs:\n    - name: default-gateway\n      namespace: gateway-system\n  hostnames:\n    - "gw-app.example.com"  # New gateway hostname for testing\n  rules:\n    - matches:\n        - path:\n            type: PathPrefix\n            value: /\n      backendRefs:\n        - name: example-app\n          port: 80\n'})}),"\n",(0,a.jsxs)(n.p,{children:["At this point, test your application through the new ",(0,a.jsx)(n.code,{children:"gw-*"})," hostname to verify the HTTPRoute works correctly."]}),"\n",(0,a.jsx)(n.h3,{id:"step-3-add-original-hostname-to-httproute",children:"Step 3: Add Original Hostname to HTTPRoute"}),"\n",(0,a.jsx)(n.p,{children:"Once testing is successful, add the actual hostname (currently used by the Ingress) as a second hostname in the HTTPRoute:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: gateway.networking.k8s.io/v1\nkind: HTTPRoute\nmetadata:\n  name: example-app\n  namespace: tenant\nspec:\n  parentRefs:\n    - name: default-gateway\n      namespace: gateway-system\n  hostnames:\n    - "gw-app.example.com"   # Gateway test hostname\n    - "app.example.com"      # Original hostname (add this)\n  rules:\n    - matches:\n        - path:\n            type: PathPrefix\n            value: /\n      backendRefs:\n        - name: example-app\n          port: 80\n'})}),"\n",(0,a.jsx)(n.h3,{id:"step-4-update-ingress-with-target-annotation",children:"Step 4: Update Ingress with Target Annotation"}),"\n",(0,a.jsxs)(n.p,{children:["Add the ",(0,a.jsx)(n.code,{children:"external-dns.alpha.kubernetes.io/target"})," annotation to the Ingress resource, pointing to the Gateway's load balancer IP address:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: example-app\n  namespace: tenant\n  annotations:\n    external-dns.alpha.kubernetes.io/target: "your-gw-ip-address"  # Gateway LB IP\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: app.example.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: example-app\n                port:\n                  number: 80\n'})}),"\n",(0,a.jsxs)(n.admonition,{title:"Finding the Gateway IP",type:"tip",children:[(0,a.jsx)(n.p,{children:"Depending on how you deployed your Gateway it might be in a different namespace and with a different name so the command bellow might not be accurate."}),(0,a.jsx)(n.p,{children:"Get the Gateway's load balancer IP with:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl get svc -n gateway-system envoy-gateway-lb -o jsonpath='{.status.loadBalancer.ingress[0].ip}'\n"})}),(0,a.jsx)(n.p,{children:"Using the IP address is preferred over a hostname for the target annotation."})]}),"\n",(0,a.jsx)(n.h3,{id:"step-5-wait-for-dns-propagation",children:"Step 5: Wait for DNS Propagation"}),"\n",(0,a.jsxs)(n.p,{children:["Let external-dns update the DNS records. The A record for ",(0,a.jsx)(n.code,{children:"app.example.com"})," will now point to the Gateway's IP instead of the Ingress controller's IP."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Verify DNS has been updated\ndig +short app.example.com\n\n# Should return the Gateway LB IP (e.g., 20.100.50.25)\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"The DNS switch is now complete!"})," Traffic is flowing through the Gateway."]}),"\n",(0,a.jsx)(n.h3,{id:"step-6-remove-ingress-resources",children:"Step 6: Remove Ingress Resources"}),"\n",(0,a.jsx)(n.p,{children:"Once you've verified traffic is flowing correctly through the Gateway, remove the old Ingress resources:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl delete ingress example-app -n tenant\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-7-update-txt-record-ownership",children:"Step 7: Update TXT Record Ownership"}),"\n",(0,a.jsxs)(n.p,{children:["External-dns creates TXT records to track ownership of DNS records. After removing the Ingress, update the TXT record's owner ID from ",(0,a.jsx)(n.code,{children:"ingress"})," to ",(0,a.jsx)(n.code,{children:"httproute"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# List TXT records\naz network dns record-set txt list \\\n  --resource-group <dns-resource-group> \\\n  --zone-name <your-domain.com> \\\n  --output table\n\n# The ownership TXT record typically looks like:\n# heritage=external-dns,external-dns/owner=<cluster-id>,external-dns/resource=ingress/tenant/example-app\n"})}),"\n",(0,a.jsx)(n.p,{children:"You may need to delete the old TXT record so external-dns can recreate it with the correct owner:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Delete old ownership record (external-dns will recreate it)\naz network dns record-set txt delete \\\n  --resource-group <dns-resource-group> \\\n  --zone-name <your-domain.com> \\\n  --name <txt-record-name> \\\n  --yes\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-8-optional-clean-up-httproute-hostnames",children:"Step 8 (Optional): Clean Up HTTPRoute Hostnames"}),"\n",(0,a.jsxs)(n.p,{children:["Remove the temporary ",(0,a.jsx)(n.code,{children:"gw-*"})," hostname from the HTTPRoute, keeping only the original hostname:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: gateway.networking.k8s.io/v1\nkind: HTTPRoute\nmetadata:\n  name: example-app\n  namespace: tenant\nspec:\n  parentRefs:\n    - name: default-gateway\n      namespace: gateway-system\n  hostnames:\n    - "app.example.com"  # Only the original hostname\n  rules:\n    - matches:\n        - path:\n            type: PathPrefix\n            value: /\n      backendRefs:\n        - name: example-app\n          port: 80\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Also clean up the ",(0,a.jsx)(n.code,{children:"gw-*"})," DNS records if they're no longer needed."]}),"\n",(0,a.jsx)(n.h2,{id:"summary-checklist",children:"Summary Checklist"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Lower TTL to 5 seconds for Ingress A records"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Wait for previous TTL to expire"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Create HTTPRoute with ",(0,a.jsx)(n.code,{children:"gw-"})," prefixed hostname"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Test application through new hostname"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add original hostname to HTTPRoute"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add ",(0,a.jsx)(n.code,{children:"external-dns.alpha.kubernetes.io/target"})," annotation to Ingress"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Verify DNS points to Gateway IP"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Delete Ingress resource"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Update/recreate TXT ownership records"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","(Optional) Remove ",(0,a.jsx)(n.code,{children:"gw-"})," hostname from HTTPRoute"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","(Optional) Restore TTL to normal value (e.g., 300 seconds)"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"rollback-procedure",children:"Rollback Procedure"}),"\n",(0,a.jsx)(n.p,{children:"If issues occur during migration:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Remove the ",(0,a.jsx)(n.code,{children:"external-dns.alpha.kubernetes.io/target"})," annotation from the Ingress"]}),"\n",(0,a.jsx)(n.li,{children:"Wait for external-dns to update DNS back to the Ingress controller IP"}),"\n",(0,a.jsxs)(n.li,{children:["Remove the original hostname from the HTTPRoute (keep only ",(0,a.jsx)(n.code,{children:"gw-*"})," for future testing)"]}),"\n",(0,a.jsx)(n.li,{children:"Investigate and resolve issues before retrying"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/xks/operator-guide/ingress-nginx%20deprecation/gateway-api",children:"Gateway API Guide"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/xks/operator-guide/ingress-nginx%20deprecation/envoy-gateway",children:"Envoy Gateway Guide"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/xks/operator-guide/ingress-nginx%20deprecation/ingress-nginx-retiring",children:"Ingress Nginx Migration Overview"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453(e,n,t){t.d(n,{R:()=>i,x:()=>o});var s=t(6540);const a={},r=s.createContext(a);function i(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);