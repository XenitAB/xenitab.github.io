"use strict";(globalThis.webpackChunkhome=globalThis.webpackChunkhome||[]).push([[7491],{8453(e,n,t){t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const o={},s=r.createContext(o);function i(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:n},e.children)}},9389(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"xks/operator-guide/blue-green","title":"Blue Green Clusters","description":"For different reasons you might want to create a completely new cluster, this can be for many reasons like:","source":"@site/docs/xks/operator-guide/blue-green.md","sourceDirName":"xks/operator-guide","slug":"/xks/operator-guide/blue-green","permalink":"/docs/xks/operator-guide/blue-green","draft":false,"unlisted":false,"editUrl":"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/blue-green.md","tags":[],"version":"current","frontMatter":{"id":"blue-green","title":"Blue Green Clusters"},"sidebar":"docs","previous":{"title":"Blast Radius","permalink":"/docs/xks/operator-guide/blast-radius"},"next":{"title":"AWS azure-devops","permalink":"/docs/xks/operator-guide/aws-azdo"}}');var o=t(4848),s=t(8453);const i={id:"blue-green",title:"Blue Green Clusters"},a=void 0,l={},d=[{value:"Workflow",id:"workflow",level:2},{value:"DNS migration",id:"dns-migration",level:2},{value:"Azure",id:"azure",level:3}];function c(e){const n={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"For different reasons you might want to create a completely new cluster, this can be for many reasons like:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Broken cluster"}),"\n",(0,o.jsx)(n.li,{children:"A test of patching the cluster"}),"\n",(0,o.jsx)(n.li,{children:"Major breaking change"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Thanks to this XKF supports performing blue-green deployment on an entire Kubernetes cluster, this is applicable to both Azure and AWS.\nThese docs are intended for both clouds, the main difference is in the naming."}),"\n",(0,o.jsx)(n.p,{children:"Today XKS does not support any way of only doing blue-green deployment on a specific environment.\nIf you need to perform blue-green deployment on QA you should do it in dev and prod as well.\nWe think that the risk is too great that you by mistake get drift between the modules used in the different clusters."}),"\n",(0,o.jsx)(n.h2,{id:"workflow",children:"Workflow"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"We assume that the workloads on the clusters are stateless and can run multiple instances."}),"\n"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Set up a new cluster in the target environment using Terraform"}),"\n",(0,o.jsxs)(n.li,{children:["Verify that the new cluster is functioning as intended","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["You ",(0,o.jsx)(n.strong,{children:"will not"})," be able to verify any ingress"]}),"\n",(0,o.jsxs)(n.li,{children:["You ",(0,o.jsx)(n.strong,{children:"will not"})," be able to use AZAD-proxy in the newly created cluster"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.li,{children:"Change the TXT DNS records over to the newly created cluster"}),"\n",(0,o.jsx)(n.li,{children:"Verify that the ingress traffic is migrated to the new cluster and it is working as intended"}),"\n",(0,o.jsx)(n.li,{children:"Destroy the old cluster using terraform"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"dns-migration",children:"DNS migration"}),"\n",(0,o.jsx)(n.p,{children:"You can find a small small script bellow to make the migration of DNS easier.\nAs always use at your own risk and make sure that you understand what the script does."}),"\n",(0,o.jsx)(n.p,{children:"Our recommendation is that you migrate one DNS record manually and verify that the ingress and the new cluster is working as intended,\nwhen you know that you can run the script."}),"\n",(0,o.jsx)(n.h3,{id:"azure",children:"Azure"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'ENVIRONMENT="dev"\nOLD_OWNER_ID="${ENVIRONMENT}-aks1"\nNEW_OWNER_ID="${ENVIRONMENT}-aks2"\nRESOURCE_GROUP_NAME="rg-${ENVIRONMENT}-we-aks"\nZONE_NAME="${ENVIRONMENT}.domain.se"\nZONE_RECORDS=$(az network dns record-set txt list -g ${RESOURCE_GROUP_NAME} -z ${ZONE_NAME} | jq -rc \'.[]\')\nZONE_RECORDS_CSV_ARRAY=( $(jq -rc \'. | [.name, (.txtRecords[0].value[0] | @base64)] | join(";")\' <<< "${ZONE_RECORDS}") )\nfor ZONE_RECORD_CSV in "${ZONE_RECORDS_CSV_ARRAY[@]}"; do\n  ZONE_RECORD_NAME=$(awk -F\';\' \'{print $1}\' <<< $ZONE_RECORD_CSV)\n  OLD_ZONE_TXT_VALUE=$(awk -F\';\' \'{print $2}\' <<< $ZONE_RECORD_CSV | base64 -d)\n  if [[ ${OLD_ZONE_TXT_VALUE} =~ "owner=${OLD_OWNER_ID}" ]]; then\n    NEW_ZONE_TXT_VALUE=${OLD_ZONE_TXT_VALUE/owner=${OLD_OWNER_ID}/owner=${NEW_OWNER_ID}}\n    echo Updating external-dns owner of ${ZONE_RECORD_NAME}: ${OLD_OWNER_ID} to ${NEW_OWNER_ID}\n    az network dns record-set txt add-record --resource-group ${RESOURCE_GROUP_NAME} --zone-name ${ZONE_NAME} --record-set-name ${ZONE_RECORD_NAME} --value "${NEW_ZONE_TXT_VALUE}" 1>/dev/null\n    az network dns record-set txt remove-record --resource-group ${RESOURCE_GROUP_NAME} --zone-name ${ZONE_NAME} --record-set-name ${ZONE_RECORD_NAME} --value "${OLD_ZONE_TXT_VALUE}" 1>/dev/null\n  fi\ndone\n'})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}}}]);