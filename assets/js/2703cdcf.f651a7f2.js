"use strict";(globalThis.webpackChunkhome=globalThis.webpackChunkhome||[]).push([[6339],{4316(e,n,o){o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"xks/operator-guide/kubernetes/aks","title":"AKS","description":"System Node Pool","source":"@site/docs/xks/operator-guide/kubernetes/aks.md","sourceDirName":"xks/operator-guide/kubernetes","slug":"/xks/operator-guide/kubernetes/aks","permalink":"/docs/xks/operator-guide/kubernetes/aks","draft":false,"unlisted":false,"editUrl":"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/kubernetes/aks.md","tags":[],"version":"current","frontMatter":{"id":"aks","title":"AKS"},"sidebar":"docs","previous":{"title":"CVE Information","permalink":"/docs/xks/operator-guide/cve"},"next":{"title":"EKS","permalink":"/docs/xks/operator-guide/kubernetes/eks"}}');var t=o(4848),a=o(8453);o(8180);const r={id:"aks",title:"AKS"},i=void 0,l={},d=[{value:"System Node Pool",id:"system-node-pool",level:2},{value:"Sizing Nodes",id:"sizing-nodes",level:3},{value:"Modifying Nodes",id:"modifying-nodes",level:3},{value:"Update AKS cluster",id:"update-aks-cluster",level:2},{value:"Useful commands in Kubernetes",id:"useful-commands-in-kubernetes",level:3},{value:"Terraform update Kubernetes version",id:"terraform-update-kubernetes-version",level:3},{value:"CLI update Kubernetes version",id:"cli-update-kubernetes-version",level:3},{value:"Upgrading node pools without upgrading cluster",id:"upgrading-node-pools-without-upgrading-cluster",level:3},{value:"Change vm size through Terraform",id:"change-vm-size-through-terraform",level:2},{value:"AKS resources",id:"aks-resources",level:2},{value:"VMSS inject commands",id:"vmss-inject-commands",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"system-node-pool",children:"System Node Pool"}),"\n",(0,t.jsxs)(n.p,{children:["AKS requires the configuration of a system node pool when creating a cluster. This system node pool is not like the other additional node pools. It is tightly coupled to the AKS cluster. It is not\npossible without manual intervention to change the instance type or taints on this node pool without recreating the cluster. Additionally the system node pool cannot scale down to zero, for AKS to\nwork there has to be at least one instance present. This is because critical system pods like Tunnelfront and CoreDNS will by default run on the system node pool. For more information about AKS\nsystem node pool refer to the ",(0,t.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/aks/use-system-pools#system-and-user-node-pools",children:"official documentation"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["XKS follows the Azure recommendation and runs only system critical applications on the system node pool. Doing this protects services like CoreDNS from starvation or memory issues caused by user\napplications running on the same nodes. This is achieved by adding the taint ",(0,t.jsx)(n.code,{children:"CriticalAddonsOnly"})," to all of the system nodes."]}),"\n",(0,t.jsx)(n.h3,{id:"sizing-nodes",children:"Sizing Nodes"}),"\n",(0,t.jsx)(n.p,{children:"Smaller AKS clusters can survive with a single node as the load on the system applications will be moderately low. In larger clusters and production clusters it is recommended to run at least three\nsystem nodes that may be larger in size. This section aims to describe how to properly size the system nodes."}),"\n",(0,t.jsxs)(n.p,{children:["The minimum requirement for a system node is a VM with at least 2 vCPUs and 4GB of memory. Burstable B series VMs are not recommended. A good starting point for all clusters are the D series node\ntypes which have a balance of CPU and memory resources. A good starting point is a node of type ",(0,t.jsx)(n.code,{children:"Standard_D2as_v4"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"More work has to be done in this area regarding sizing and scaling of the system node pools to achieve a standardized solution."}),"\n",(0,t.jsx)(n.h3,{id:"modifying-nodes",children:"Modifying Nodes"}),"\n",(0,t.jsx)(n.p,{children:"There may come times when Terraform wants to recreate the AKS cluster when the system node pool has been updated. This happens when updating certain properties in the system node pool. It is still\npossible to do these updates without recreating the cluster, but it requires some manual intervention. AKS requires at least one system node pool but does not have an upper limit. This makes it\npossible to manually add a new temporary system node pool. Remove the existing default node pool created by Terraform. Create a new system node pool with the same name but with the updated parameters.\nFinally remove the temporary node pool. Terraform will just assume that the changes have already been applied and import the new state without any other complaints."}),"\n",(0,t.jsx)(n.p,{children:"Start off with creating a temporary system pool. Make sure to replace the cluster name and resource groups to the correct values."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'az aks nodepool add --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name temp --mode "System" --node-count 1\n'})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"It may not be possible to create a new node pool with the current Kubernetes version if the cluster has not been updated in a while. Azure will remove minor versions as new versions are released. In\nthat case you will need to upgrade the cluster to the latest minor version before making changes to the system pool, as AKS will not allow a node with a newer version than the control plane."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Delete the system node pool created by Terraform:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks nodepool delete --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name default\n"})}),"\n",(0,t.jsx)(n.p,{children:"Create a new node pool with the new configuration. In this case it is setting a new instance type and adding a taint:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'az aks nodepool add --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name default --mode "System" --zones 1 2 3 --node-vm-size "Standard_D2as_v4" --node-taints "CriticalAddonsOnly=true:NoSchedule"\n--node-count 1\n'})}),"\n",(0,t.jsx)(n.p,{children:"Delete the temporary pool:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks nodepool delete --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name temp\n"})}),"\n",(0,t.jsxs)(n.p,{children:["For additional information about updating the system nodes refer to ",(0,t.jsx)(n.a,{href:"https://pumpingco.de/blog/modify-aks-default-node-pool-in-terraform-without-redeploying-the-cluster/",children:"this blog post"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"update-aks-cluster",children:"Update AKS cluster"}),"\n",(0,t.jsx)(n.h3,{id:"useful-commands-in-kubernetes",children:"Useful commands in Kubernetes"}),"\n",(0,t.jsx)(n.p,{children:"When patching an AKS cluster or just upgrading nodes it can be useful to watch your resources in Kubernetes."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'# Show node version\nkubectl get nodes -o jsonpath=\'{range .items[*]}{.metadata.name}{"\\t"}{.metadata.labels.kubernetes\\.azure\\.com\\/node-image-version}{"\\n"}{end}\'\n\n# Watch nodes\nwatch kubectl get nodes\n\n# Check the status of all pods in the cluster\nkubectl get pods -A\n'})}),"\n",(0,t.jsx)(n.h3,{id:"terraform-update-kubernetes-version",children:"Terraform update Kubernetes version"}),"\n",(0,t.jsx)(n.p,{children:"TBD"}),"\n",(0,t.jsx)(n.h3,{id:"cli-update-kubernetes-version",children:"CLI update Kubernetes version"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"export RG=rg1\nexport POOL_NAME=default\nexport CLUSTER_NAME=cluster1\nexport AZURE_LOCATION=westeurope\nexport KUBE_VERSION=1.21.9\n"})}),"\n",(0,t.jsx)(n.p,{children:"What AKS versions can I pick in this Azure location:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks get-versions --location $AZURE_LOCATION -o table\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks get-upgrades --resource-group $RG --name $CLUSTER_NAME --output table\n"})}),"\n",(0,t.jsx)(n.p,{children:"We recommend to only upgrade control-plane separately and then upgrade the nodes."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks upgrade --resource-group $RG --name $CLUSTER_NAME --kubernetes-version $KUBE_VERSION --control-plane-only\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks nodepool upgrade --resource-group $RG --cluster-name $CLUSTER_NAME --name $POOL_NAME --kubernetes-version $KUBE_VERSION\n"})}),"\n",(0,t.jsx)(n.h3,{id:"upgrading-node-pools-without-upgrading-cluster",children:"Upgrading node pools without upgrading cluster"}),"\n",(0,t.jsxs)(n.p,{children:["From time to time you might want to upgrade your Node Pools without upgrading the Kubernetes version. We always recommend to look at\nthe ",(0,t.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/aks/node-image-upgrade",children:"official documentation"}),"as well."]}),"\n",(0,t.jsx)(n.p,{children:"The node pool will spin up a new node and drain the existing one.\nWhen this is done the old node will be deleted."}),"\n",(0,t.jsx)(n.p,{children:"The below command works great for smaller clusters. If you want to upgrade more nodes faster it is possible to do so. Read the documentation for more information."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"export RG=rg1\nexport POOL_NAME=default\nexport CLUSTER_NAME=cluster1\n"})}),"\n",(0,t.jsx)(n.p,{children:"Get the latest available node versions for your node pool:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks nodepool get-upgrades --nodepool-name $POOL_NAME --cluster-name $CLUSTER_NAME --resource-group $RG\n"})}),"\n",(0,t.jsx)(n.p,{children:"Upgrade the image on the specified node pool:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"az aks nodepool upgrade --resource-group $RG --cluster-name $CLUSTER_NAME --name $POOL_NAME --node-image-only\n"})}),"\n",(0,t.jsx)(n.h2,{id:"change-vm-size-through-terraform",children:"Change vm size through Terraform"}),"\n",(0,t.jsxs)(n.p,{children:["If you want to use terraform to change the your node pools VM size you ",(0,t.jsx)(n.strong,{children:"can't"})," just change the vm_size in the additional_node_pools config.\nThis will tell Azure to drain all the nodes and then delete the existing ones, then Azure will spin up a new node pool after the existing one is gone."]}),"\n",(0,t.jsx)(n.p,{children:"This might be fine if you already have multiple additional node pools and you pods don't have specific node affinities."}),"\n",(0,t.jsx)(n.p,{children:"But if that isn't the case terraform will most likely run for ever since it won't be able to destroy the nodes that you already have workload on.\nOr even worse it will destroy the existing node and you won't have any node pools in your cluster to manage your workloads."}),"\n",(0,t.jsx)(n.p,{children:"Instead you have to add a second additional node pool in to your cluster."}),"\n",(0,t.jsx)(n.p,{children:"For example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-.hcl",children:'  additional_node_pools = [\n    {\n      name                 = "standard"\n      orchestrator_version = "1.21.2"\n      vm_size              = "Standard_E2s_v4"\n      min_count            = 1\n      max_count            = 5\n      node_labels          = {}\n      node_taints          = []\n      spot_enabled         = false\n      spot_max_price       = null\n    },\n    {\n      name                 = "standard2"\n      orchestrator_version = "1.21.2"\n      vm_size              = "Standard_F4s_v2"\n      min_count            = 1\n      max_count            = 5\n      node_labels          = {}\n      node_taints          = []\n      spot_enabled         = false\n      spot_max_price       = null\n    }\n  ]\n'})}),"\n",(0,t.jsx)(n.p,{children:"Run terraform and see that standard2 is up and running."}),"\n",(0,t.jsx)(n.p,{children:"Now you can remove the standard node pool and standard2 should be able to handle the new load."}),"\n",(0,t.jsx)(n.p,{children:"Azure will automatically drain all the data from the old standard node pool."}),"\n",(0,t.jsxs)(n.p,{children:["Remember to set min_count so that your current workload fits, you can always reduce min_count later.\nThe cluster autoscaler will scale up new vm",":s"," of standard2 but it will take time.\nDuring the creation of more standard2 nodes much of your workload might become pending."]}),"\n",(0,t.jsx)(n.h2,{id:"aks-resources",children:"AKS resources"}),"\n",(0,t.jsxs)(n.p,{children:["To get a quick overview of what is happening in AKS you can look at its ",(0,t.jsx)(n.a,{href:"https://github.com/Azure/AKS/releases",children:"changelog"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"vmss-inject-commands",children:"VMSS inject commands"}),"\n",(0,t.jsxs)(n.p,{children:["In Azure you can inject commands to VMSS instances using the ",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command",children:"Azure Linux VM agent"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["All you need to do is to get the RG of the VMSS, the node pool name and the instance ID.\nYou can find the instance ID by running ",(0,t.jsx)(n.code,{children:"az vmss list-instances -g rg1 -n nodepool1"})," and look for ",(0,t.jsx)(n.code,{children:"instanceId"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'az vmss run-command invoke -g <RG> -n <node-pool-name> --command-id RunShellScript --instance-id <instance id>  --scripts " nc -vz mcr.microsoft.com 443 "\n# example\naz vmss run-command invoke -g rg1 -n nodepool1 --command-id RunShellScript --instance-id 1  --scripts " nc -vz mcr.microsoft.com 443 "\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453(e,n,o){o.d(n,{R:()=>r,x:()=>i});var s=o(6540);const t={},a=s.createContext(t);function r(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);