<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><title data-react-helmet="true">Observability | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/xks/developer-guide/observability"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Observability | Xenit"><meta data-react-helmet="true" name="description" content="What is observability?"><meta data-react-helmet="true" property="og:description" content="What is observability?"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/xks/developer-guide/observability"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/developer-guide/observability" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/developer-guide/observability" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.018923a1.css">
<link rel="preload" href="/assets/js/runtime~main.2c69eb5d.js" as="script">
<link rel="preload" href="/assets/js/main.c6a19fb4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/xks/">Xenit Kubernetes Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design">Architecture and design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/xks/developer-guide/introduction">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/api-migrations">API migrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/secrets-management">Secrets Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/cloud-iam">Cloud IAM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/container-security">Container Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/xks/developer-guide/ci-cd/ci">CI/CD</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/scheduling-scaling">Scheduling and Scaling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/developer-guide/observability">Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/wsl2">Working with XKF from Windows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/reports">Reports</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/best-practices">Best Practices</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/xks/operator-guide/">Operator Guide</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/xenit-style-guide/containers">Xenit Style Guide</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Observability</h1></header><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-is-observability">What is observability?<a class="hash-link" href="#what-is-observability" title="Direct link to heading">â€‹</a></h2><p>Within observability we normally talk about three pillars.</p><ul><li>metrics</li><li>logging</li><li>tracing</li></ul><p>Monitoring applications is an especially important feature when developing microservices
and something that all developers of microservices needs to focus on.</p><p>We currently support two solutions to gather observability data in XKF, <a href="https://www.datadoghq.com" target="_blank" rel="noopener noreferrer">Datadog</a> and the <a href="https://opentelemetry.io/" target="_blank" rel="noopener noreferrer">Opentelemetry</a> stack which is an open-source solution.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="datadog">Datadog<a class="hash-link" href="#datadog" title="Direct link to heading">â€‹</a></h2><p>When Datadog monitoring is used the <a href="https://github.com/DataDog/datadog-operator" target="_blank" rel="noopener noreferrer">Datadog Operator</a> will be added to your cluster. On top of deploying a
Datadog agent to every node to collect metrics, logs, and traces it also adds the ability to create Datadog monitors from the cluster. The Datadog
agent handles all communication with the Datadog API meaning that individual applications do not have to deal with things such as authentication.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="logging">Logging<a class="hash-link" href="#logging" title="Direct link to heading">â€‹</a></h3><p>All logs written to <code>stdout</code> and <code>stderr</code> from applications in the tenant namespace will be collected by the Datadog agents. This means that no additional
configuration has to be done to the application, other than making sure the logs are written to the correct destination.
This means that <code>kubectl logs</code> and Datadog will display the same information.</p><p>Check the official <a href="https://docs.datadoghq.com/agent/kubernetes/log/?tab=daemonset" target="_blank" rel="noopener noreferrer">Datadog Logging Documentation</a> for more detailed information.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="metrics">Metrics<a class="hash-link" href="#metrics" title="Direct link to heading">â€‹</a></h3><p>Datadog can collect Prometheus or OpenMetrics metrics exposed by your application.
In simple terms this means that the application needs to expose an endpoint which the Datadog agent can scrape to get the metrics.
All that is required is that the Pod contains annotations which tells Datadog where to find the metrics HTTP endpoint.</p><p>Given that your application is exposing metrics on port 8080 your pod should contain the following annotations.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ad.datadoghq.com/prometheus-example.instances</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">    [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">      {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">        &quot;prometheus_url&quot;: &quot;http://%%host%%:8080/metrics&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">    ]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Check the official <a href="https://docs.datadoghq.com/agent/kubernetes/prometheus/" target="_blank" rel="noopener noreferrer">Datadog Metrics Documentation</a> for more detailed information.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="tracing">Tracing<a class="hash-link" href="#tracing" title="Direct link to heading">â€‹</a></h3><p>Datadog tracing is done with Application Performance Monitoring (APM), which sends traces from an application to Datadog.
For traces to work the application needs to be configured with the language specific libraries.
Check the <a href="https://docs.datadoghq.com/tracing/setup_overview/" target="_blank" rel="noopener noreferrer">Language Documentation</a>
for language specific instructions. Some of the languages that are supported are.</p><ul><li>Golang</li><li>C#</li><li>Java</li><li>Python</li></ul><p>Configure your Deployment with the <code>DD_AGENT_HOST</code> environment for the APM agent to know where to send the traces.</p><div class="codeBlockContainer_I0IT language-deployment.yaml theme-code-block"><div class="codeBlockContent_wNvx deployment.yaml"><pre tabindex="0" class="prism-code language-deployment.yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - env:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - name: DD_AGENT_HOST</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          valueFrom:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            fieldRef:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              fieldPath: status.hostIP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Check the official <a href="https://docs.datadoghq.com/agent/kubernetes/apm/?tab=helm" target="_blank" rel="noopener noreferrer">Datadog Tracing Documentation</a> for more detailed information.</p><p>To add tracing to Datadog&#x27;s <a href="https://docs.datadoghq.com/synthetics/browser_tests" target="_blank" rel="noopener noreferrer">Browser Test</a> results, add the URLs that the browser tests visits under UX Monitoring/Synthetic Settings/Integration Settings. See <a href="https://docs.datadoghq.com/synthetics/apm" target="_blank" rel="noopener noreferrer">Synthetic APM</a> for more information. You can see a example on how to set this up below. By using a wildcard, multiple endpoints can be traced.</p><img alt="Browser Test URLs" src="/img/assets/xks/developer-guide/browser-test-urls.png"><h3 class="anchor anchorWithStickyNavbar_mojV" id="networkpolicy-datadog">Networkpolicy datadog<a class="hash-link" href="#networkpolicy-datadog" title="Direct link to heading">â€‹</a></h3><p>When using XKF and your cluster has Datadog enabled the tenant namespace will automatically get a networkpolicy that allows egress for tracing and ingress for metrics.</p><p>You can view these rules by typing:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get networkpolicies -n </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">tenant-namespace</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="opentelemetry">Opentelemetry<a class="hash-link" href="#opentelemetry" title="Direct link to heading">â€‹</a></h2><p>To gather opentelemetry data we rely on the <a href="https://github.com/grafana/agent" target="_blank" rel="noopener noreferrer">grafana agent operator</a>.
The grafana agent operator deploys a grafana-agent in a central namespace configured as a part of XKF.</p><p>The grafana agent gathers both metrics and logs and is able to receive traces.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="metrics-1">Metrics<a class="hash-link" href="#metrics-1" title="Direct link to heading">â€‹</a></h3><p>To gather metrics data we use servicemonitors or podmonitors that is managed in XKF using the <a href="https://github.com/prometheus-operator/prometheus-operator/" target="_blank" rel="noopener noreferrer">prometheus-operator</a>.</p><p>The prometheus-operator has a great <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md" target="_blank" rel="noopener noreferrer">getting started guide</a>
but if you want a quick example you can look below.</p><p>In order for the grafana agent to find the pod you have to put this exact label on the pod/service monitor yaml: <code>xkf.xenit.io/monitoring: tenant</code>,
or else the grafana agent will not find the rule to gather the metric.</p><p>The <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener noreferrer">selectors</a> is used to find ether the pod or the service that you want to monitor.</p><p>Use a podmonitor when you do not have a service in front of your pod.
For example this might be the case when your application does not use an HTTP endpoint to get requests.</p><div class="codeBlockContainer_I0IT language-podmonitor.yaml theme-code-block"><div class="codeBlockContent_wNvx podmonitor.yaml"><pre tabindex="0" class="prism-code language-podmonitor.yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: PodMonitor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: podmonitor-example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    xkf.xenit.io/monitoring: tenant</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      app.kubernetes.io/name: app1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  podMetricsEndpoints:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - port: http-metrics</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In general use a servicemonitor when you have a service in front of your pod.</p><div class="codeBlockContainer_I0IT language-servicemonitor.yaml theme-code-block"><div class="codeBlockContent_wNvx servicemonitor.yaml"><pre tabindex="0" class="prism-code language-servicemonitor.yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ServiceMonitor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    xkf.xenit.io/monitoring: tenant</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: servicemonitor-example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  endpoints:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - interval: 60s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    port: metrics</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      app.kubernetes.io/instance: app1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can do a lot of configuration when it comes to metrics gathering but the above config will get you started.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="logging-1">Logging<a class="hash-link" href="#logging-1" title="Direct link to heading">â€‹</a></h3><p>To gather logs from your application you need to define a PodLogs object.</p><p>Just like metrics you have to define a label like <code>xkf.xenit.io/monitoring: tenant</code> in your PodLogs.
The PodLogs CRD is created by the grafana agent operator and functions very similarly to how the prometheus operator works, especially when it comes to selectors.
Below you will find a very basic example that will scrape a single pod in the namespace where it is created.</p><div class="codeBlockContainer_I0IT language-podlogs.yaml theme-code-block"><div class="codeBlockContent_wNvx podlogs.yaml"><pre tabindex="0" class="prism-code language-podlogs.yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: monitoring.grafana.com/v1alpha1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: PodLogs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: app1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    xkf.xenit.io/monitoring: tenant</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      app.kubernetes.io/name: app1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pipelineStages:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - cri: {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can do a lot of configuration when it comes to log filtering using PodLogs. For example you can drop specific log types that you do not want to send to your long time storage.
Sadly the grafana agent operator does not supply great documentation around how to define this configuration in the operator.
However, together with running <code>kubectl explain podlogs.monitoring.grafana.com.spec.pipelineStages</code> on the cluster and
reading the <a href="https://grafana.com/docs/loki/latest/clients/promtail/pipelines/" target="_blank" rel="noopener noreferrer">official documentation</a> on how to create pipelines you can get a good understanding of how to create the configuration that you need.</p><p>If you do not have any needs to filter or do any custom config per application you can create a namespace-wide PodLogs gatherer.</p><div class="codeBlockContainer_I0IT language-podlogs.yaml theme-code-block"><div class="codeBlockContent_wNvx podlogs.yaml"><pre tabindex="0" class="prism-code language-podlogs.yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: monitoring.grafana.com/v1alpha1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: PodLogs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: tenant-namespace-log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    xkf.xenit.io/monitoring: tenant</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  selector: {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pipelineStages:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - cri: {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="tracing-1">Tracing<a class="hash-link" href="#tracing-1" title="Direct link to heading">â€‹</a></h3><p>The tracing setup is a bit different compared to logging and metrics, instead of having some yaml file where you define how to gather metrics and logs from
your application, you instead push data to a central collector.</p><p>Opentelemetry supports both HTTP and gRPC communication to gather traces from your application.</p><p>To send HTTP data we use <code>4318</code> and for gRPC we use <code>4317</code>.</p><p>Point your OpenTelemetry SDK to <a href="http://grafana-agent-traces.opentelemetry.svc.cluster.local:4318/v1/traces" target="_blank" rel="noopener noreferrer">http://grafana-agent-traces.opentelemetry.svc.cluster.local:4318/v1/traces</a>
or <a href="http://grafana-agent-traces.opentelemetry.svc.cluster.local:4317/v1/traces" target="_blank" rel="noopener noreferrer">http://grafana-agent-traces.opentelemetry.svc.cluster.local:4317/v1/traces</a>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="tail-based-sampling">Tail-based sampling<a class="hash-link" href="#tail-based-sampling" title="Direct link to heading">â€‹</a></h4><p>By default the grafana agent that is deployed by XKF forwards all traces without any special config to your service provider.
This can cause high costs thanks to the amount of data that is sent.
You can configure the agent to use <code>probabilistic sampling</code> which grafana agent delivers their own solution for called <a href="https://grafana.com/docs/tempo/latest/grafana-agent/tail-based-sampling/" target="_blank" rel="noopener noreferrer">tail-based sampling</a>, which can help you solve this issue.</p><p>To setup a custom agent with tail-based sampling you can setup your own trace agent with the custom config that you want and then have it forward all the traffic to our central trace agent in the <code>opentelemetry</code> namespace.
Below you can find a simple example configmap that you can use together with your trace agent to send data to the central agent.</p><div class="codeBlockContainer_I0IT language-trace-agent-configmap.yaml theme-code-block"><div class="codeBlockContent_wNvx trace-agent-configmap.yaml"><pre tabindex="0" class="prism-code language-trace-agent-configmap.yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: grafana-agent-traces</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  agent.yaml: |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tempo:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - name: default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          remote_write:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            - endpoint: &quot;grafana-agent-traces.grafana-agent.svc.cluster.local:4317&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              insecure: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          receivers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            otlp:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              protocols:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                http: {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                grpc: {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          tail_sampling:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            # policies define the rules by which traces will be sampled. Multiple policies</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            # can be added to the same pipeline.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            # For more information: https://grafana.com/docs/agent/latest/configuration/traces-config/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/b2327211df976e0a57ef0425493448988772a16b/processor/tailsamplingprocessor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            policies:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              - probabilistic: {sampling_percentage: 10}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              - status_code: {status_codes: [ERROR, UNSET]}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="networkpolicy-grafana-agent">Networkpolicy grafana agent<a class="hash-link" href="#networkpolicy-grafana-agent" title="Direct link to heading">â€‹</a></h3><p>When using XKF and your cluster have enabled the grafana agent your tenant namespace will automatically get a networkpolicy that allows
incoming metrics gathering and egress for tracing.</p><p>You can view these rules by typing:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get networkpolicies -n </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">tenant-namespace</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/developer-guide/observability.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xks/developer-guide/scheduling-scaling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scheduling and Scaling</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/xks/developer-guide/networking"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Networking</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-observability" class="table-of-contents__link toc-highlight">What is observability?</a></li><li><a href="#datadog" class="table-of-contents__link toc-highlight">Datadog</a><ul><li><a href="#logging" class="table-of-contents__link toc-highlight">Logging</a></li><li><a href="#metrics" class="table-of-contents__link toc-highlight">Metrics</a></li><li><a href="#tracing" class="table-of-contents__link toc-highlight">Tracing</a></li><li><a href="#networkpolicy-datadog" class="table-of-contents__link toc-highlight">Networkpolicy datadog</a></li></ul></li><li><a href="#opentelemetry" class="table-of-contents__link toc-highlight">Opentelemetry</a><ul><li><a href="#metrics-1" class="table-of-contents__link toc-highlight">Metrics</a></li><li><a href="#logging-1" class="table-of-contents__link toc-highlight">Logging</a></li><li><a href="#tracing-1" class="table-of-contents__link toc-highlight">Tracing</a></li><li><a href="#networkpolicy-grafana-agent" class="table-of-contents__link toc-highlight">Networkpolicy grafana agent</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.2c69eb5d.js"></script>
<script src="/assets/js/main.c6a19fb4.js"></script>
</body>
</html>