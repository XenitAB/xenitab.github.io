<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><title data-react-helmet="true">Continuous Delivery | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/xks/developer-guide/ci-cd/cd"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Continuous Delivery | Xenit"><meta data-react-helmet="true" name="description" content="Continuous Delivery (CD) should be the only way to make changes to running applications in the XKS service."><meta data-react-helmet="true" property="og:description" content="Continuous Delivery (CD) should be the only way to make changes to running applications in the XKS service."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/xks/developer-guide/ci-cd/cd"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/developer-guide/ci-cd/cd" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/developer-guide/ci-cd/cd" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.018923a1.css">
<link rel="preload" href="/assets/js/runtime~main.5a5da298.js" as="script">
<link rel="preload" href="/assets/js/main.d34b2061.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/xks/">Xenit Kubernetes Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design">Architecture and design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/xks/developer-guide/introduction">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/api-migrations">API migrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/secrets-management">Secrets Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/cloud-iam">Cloud IAM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/container-security">Container Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/xks/developer-guide/ci-cd/ci">CI/CD</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/ci-cd/ci">Continuous Integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/developer-guide/ci-cd/cd">Continuous Delivery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/ci-cd/gitops">GitOps a la XKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/ci-cd/flux">Flux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/ci-cd/repo-structure">GitOps Repository Structure</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/scheduling-scaling">Scheduling and Scaling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/observability">Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/wsl2">Working with XKF from Windows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/reports">Reports</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/best-practices">Best Practices</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/xks/operator-guide/">Operator Guide</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/xenit-style-guide/containers">Xenit Style Guide</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Continuous Delivery</h1></header><p>Continuous Delivery (CD) should be the only way to make changes to running applications in the XKS service.
This is to ensure that changes are consistent and tracked in a centralized manner that can be observed by all.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitops">GitOps<a class="hash-link" href="#gitops" title="Direct link to heading">â€‹</a></h2><h2 class="anchor anchorWithStickyNavbar_mojV" id="azure-ad-identity">Azure AD Identity<a class="hash-link" href="#azure-ad-identity" title="Direct link to heading">â€‹</a></h2><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitops-setup">GitOps Setup<a class="hash-link" href="#gitops-setup" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="validation-for-gitops-status">Validation for GitOps Status<a class="hash-link" href="#validation-for-gitops-status" title="Direct link to heading">â€‹</a></h3><p>Important to remember is to setup the Build Validation for the Status pipeline to trigger correctly.</p><p>That is done:</p><ul><li>In Azure devops</li><li>Project Settings -&gt; Repositories -&gt; &#x27;your-gitops-repo&#x27; -&gt; On the &#x27;Policies&#x27; tab</li><li>Select your default branch, usually &#x27;main&#x27;. And on the &#x27;Build Validation&#x27; section, press the &#x27;+&#x27; button.</li><li>Select your Status pipeline</li><li>Enter the following settings:</li><li>Trigger: Automatic</li><li>Policy requirement: Required</li><li>Build expiration: 12h</li></ul><p>Also see images below:</p><img alt="build-validation" src="/img/assets/xks/developer-guide/build-validation.png"><img alt="build-validation-setup" src="/img/assets/xks/developer-guide/build-validation-setup.png"><img alt="build-validation-final" src="/img/assets/xks/developer-guide/build-validation-final.png"><h2 class="anchor anchorWithStickyNavbar_mojV" id="setup-cicd-pipeline">Setup CI/CD pipeline<a class="hash-link" href="#setup-cicd-pipeline" title="Direct link to heading">â€‹</a></h2><p>At Xenit we have created a CI/CD template to make it easier to get started with GitOps in our case using FluxV2 and the <a href="https://toolkit.fluxcd.io/" target="_blank" rel="noopener noreferrer">GitOps toolkit</a>.</p><p>You can find the base for all our Azure DevOps pipelines in our <a href="https://github.com/XenitAB/azure-devops-templates/tree/main/gitops-v2" target="_blank" rel="noopener noreferrer">Azure Devops Templates repo</a>.</p><p>Follow the example documentation on how to setup your base repo.
Below we will explain how to do the manual steps that is needed to get Azure DevOps to enable some of the flows that we are creating.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="enable-ci-user-to-push-to-gitops-repo">Enable CI user to push to gitops repo<a class="hash-link" href="#enable-ci-user-to-push-to-gitops-repo" title="Direct link to heading">â€‹</a></h3><p>The core feature of the gitops repo is that one of the pipelines automatically updates the image tag in your repository so Flux will automatically update your deployment in Kubernetes.</p><p>We have to grant it permissions to do this, sadly manually...</p><p>In cases where there are multiple &quot;build services&quot; make sure that you are setting correct permissons the correct one. This appears to be a trial-and-error based mission. Use the <code>Project Collection Build Service ({your organization})</code>, not the group <code>Project Collection Build Service Accounts ({your organization})</code>.</p><img alt="CI access" src="/img/assets/xks/developer-guide/gitops_repo_settings.png"><h3 class="anchor anchorWithStickyNavbar_mojV" id="service-connections">Service connections<a class="hash-link" href="#service-connections" title="Direct link to heading">â€‹</a></h3><p>To be able to talk from Azure DevOps to AKS using our gitops pipelines we also need to configure service connections to tenant namespace.
Sadly setting up the Service Connections is a manual step.</p><p>Get the needed config.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault secret show --vault-name </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vault-name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --name </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">secret-name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> -o tsv --query value</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault secret show --vault-name kv-prod-we-core-1337 --name sp-rg-xks-prod-backend-contributor -o tsv --query value</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># The output will look something like this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;clientId&quot;</span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;12345&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;clientSecret&quot;</span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;SoMuchSecret&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;subscriptionId&quot;</span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sub-id&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;tenantId&quot;</span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;tenant-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In Azure DevOps:
Project settings -&gt; Service connections -&gt; New service connection -&gt; Azure Resource Manager -&gt; Service principal (manual)</p><ul><li>Subscription Id = subscriptionId</li><li>Service Principal Id = clientId</li><li>Service principal key = clientSecret</li><li>Tenant ID = tenantId</li><li>Service connection name = random-name</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/developer-guide/ci-cd/cd.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xks/developer-guide/ci-cd/ci"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Continuous Integration</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/xks/developer-guide/ci-cd/gitops"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">GitOps a la XKS</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#gitops" class="table-of-contents__link toc-highlight">GitOps</a></li><li><a href="#azure-ad-identity" class="table-of-contents__link toc-highlight">Azure AD Identity</a></li><li><a href="#gitops-setup" class="table-of-contents__link toc-highlight">GitOps Setup</a><ul><li><a href="#validation-for-gitops-status" class="table-of-contents__link toc-highlight">Validation for GitOps Status</a></li></ul></li><li><a href="#setup-cicd-pipeline" class="table-of-contents__link toc-highlight">Setup CI/CD pipeline</a><ul><li><a href="#enable-ci-user-to-push-to-gitops-repo" class="table-of-contents__link toc-highlight">Enable CI user to push to gitops repo</a></li><li><a href="#service-connections" class="table-of-contents__link toc-highlight">Service connections</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.5a5da298.js"></script>
<script src="/assets/js/main.d34b2061.js"></script>
</body>
</html>