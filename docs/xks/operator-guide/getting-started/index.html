<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><title data-react-helmet="true">Getting Started | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/xks/operator-guide/getting-started"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Getting Started | Xenit"><meta data-react-helmet="true" name="description" content="Bootstrap"><meta data-react-helmet="true" property="og:description" content="Bootstrap"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/xks/operator-guide/getting-started"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/getting-started" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/getting-started" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.018923a1.css">
<link rel="preload" href="/assets/js/runtime~main.2c69eb5d.js" as="script">
<link rel="preload" href="/assets/js/main.e8f9d7a3.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/xks/">Xenit Kubernetes Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design">Architecture and design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/xks/developer-guide/introduction">Developer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/">Operator Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/agents">Agents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blast-radius">Blast Radius</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blue-green">Blue Green Clusters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/aws-azdo">AWS azure-devops</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/github">XKF on Github</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/cve">CVE Information</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/xks/operator-guide/kubernetes/aks">Kubernetes</a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/xenit-style-guide/containers">Xenit Style Guide</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Getting Started</h1></header><h2 class="anchor anchorWithStickyNavbar_mojV" id="bootstrap">Bootstrap<a class="hash-link" href="#bootstrap" title="Direct link to heading">â€‹</a></h2><h2 class="anchor anchorWithStickyNavbar_mojV" id="add-new-tenant">Add New Tenant<a class="hash-link" href="#add-new-tenant" title="Direct link to heading">â€‹</a></h2><p>When creating a new tenant there are a number of (for now manual) processes to perform.</p><p>In this scenario we are assuming that you are using Azure DevOps and that you have already created a project and organization.</p><p>In many places in the text we have provided names, they are just examples, all of these names can be exchanged to fit your needs. In this case let us call it <code>project1</code>. In the future we should manually import a repository.
<a href="https://github.com/XenitAB/azure-devops-templates" target="_blank" rel="noopener noreferrer">https://github.com/XenitAB/azure-devops-templates</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="import-azure-devops-templates-pipeline">Import azure-devops-templates pipeline<a class="hash-link" href="#import-azure-devops-templates-pipeline" title="Direct link to heading">â€‹</a></h3><p>To make sure that the <code>azure-devops-templates</code> repo is up to date we have an automatic CI that fetches updates from upstream to your local Azure DevOps clone.</p><p>Go to pipelines -&gt; New pipeline -&gt; Azure Repos Git -&gt; azure-devops-templates -&gt; Existing Azure Pipelines YAML file</p><p>Import the pipeline from the following path: <code>/.ci/pipeline.yaml</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="setup-xks">Setup XKS<a class="hash-link" href="#setup-xks" title="Direct link to heading">â€‹</a></h3><p>In this case we will only setup a single XKS cluster in one environment, in our case dev. It is easy to add more environments when you have created your first one.</p><p>At Xenit we are using Terraform modules that we share <a href="https://github.com/XenitAB/terraform-modules" target="_blank" rel="noopener noreferrer">upstream</a></p><p>To setup XKS we will utilize 4 modules:</p><ul><li>governance-global</li><li>governance-regional</li><li>core</li><li>aks</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-terraform-repo">Create Terraform repo<a class="hash-link" href="#create-terraform-repo" title="Direct link to heading">â€‹</a></h3><p>Of course we need a place to store our Terraform code so create one in your Azure DevOps organization.
TODO create a example repo that uses our Terraform modules.</p><p>You can today see a example of the <a href="https://github.com/XenitAB/github-actions/blob/main/docker/template/Makefile" target="_blank" rel="noopener noreferrer">Makefile</a>.</p><p>This is how we normally <a href="https://www.terraform.io/docs/language/modules/develop/structure.html" target="_blank" rel="noopener noreferrer">structure</a> our tenant repo.</p><div class="codeBlockContainer_I0IT language-txt theme-code-block"><div class="codeBlockContent_wNvx txt"><pre tabindex="0" class="prism-code language-txt codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ Makefile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ README.md</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ aks</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ outputs.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ common.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dev.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ prod.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â””â”€â”€ qa.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â””â”€â”€ variables.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ core</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ outputs.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ common.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dev.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ prod.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â””â”€â”€ qa.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â””â”€â”€ variables.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ global.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”œâ”€â”€ governance</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ outputs.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”œâ”€â”€ variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ common.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dev.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ prod.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â”‚Â Â  â””â”€â”€ qa.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">â”‚Â Â  â””â”€â”€ variables.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="update-repo">Update repo<a class="hash-link" href="#update-repo" title="Direct link to heading">â€‹</a></h3><p>We need to update a number of settings in a number of places in your Terraform repo.</p><p>Generate a SUFFIX that should be tfstate + a few random numbers, for example <code>tfstate1234</code>.</p><p>Update the Makefile SUFFIX variable with the suffix and the random number.</p><p>Also update global.tfvars with the same random number.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-terraform-storage">Create Terraform storage<a class="hash-link" href="#create-terraform-storage" title="Direct link to heading">â€‹</a></h3><p>In order to store a Terraform state we need to prepare that.</p><p>We have written a small Go tool that will help out with <a href="https://github.com/XenitAB/github-actions/tree/main/docker/go-tf-prepare" target="_blank" rel="noopener noreferrer">that</a>.</p><p>Instead of running these scripts manually we will use the makefile.</p><p>We use one Terrafrom state per <code>DIR</code> and <code>ENV</code>.
Lets create the first Terraform state, in this case governance.</p><p><code>make prepare ENV=dev DIR=governance</code></p><p>You will need to run the prepare command for each separate Terraform folder.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-governance">Configure governance<a class="hash-link" href="#configure-governance" title="Direct link to heading">â€‹</a></h3><p>After defining the variables and you have have applied your config:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">make</span><span class="token plain"> plan </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ENV</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">dev </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">DIR</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">governance</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># If everything looks good</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">make</span><span class="token plain"> apply </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ENV</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">dev </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">DIR</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">governance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>By default you don&#x27;t get access to the key vaults that governance creates.
You should probably give the access to a group that you and your team have access to but to get started you can run the following.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AZ_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">az ad user show --id </span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot;your@email&quot;</span><span class="token variable" style="color:rgb(191, 199, 213)"> --output tsv --query </span><span class="token variable function" style="color:rgb(130, 170, 255)">id</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">KEYVAULTNAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">kv-favorite-name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault set-policy --name </span><span class="token variable" style="color:rgb(191, 199, 213)">$KEYVAULTNAME</span><span class="token plain"> --object-id </span><span class="token variable" style="color:rgb(191, 199, 213)">$AZ_ID</span><span class="token plain"> --secret-permissions backup delete get list purge recover restore </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> --key-permissions backup create decrypt delete encrypt get </span><span class="token function" style="color:rgb(130, 170, 255)">import</span><span class="token plain"> list purge recover restore sign unwrapKey update verify wrapKey --certificate-permissions backup create delete deleteissuers get getissuers </span><span class="token function" style="color:rgb(130, 170, 255)">import</span><span class="token plain"> list listissuers managecontacts manageissuers purge recover restore setissuers update</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-core">Configure core<a class="hash-link" href="#configure-core" title="Direct link to heading">â€‹</a></h3><p>Get a CIDR network for your AKS env per env.
Define in <code>core/variables/env.tfvars</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-aks-cluster">Configure AKS cluster<a class="hash-link" href="#configure-aks-cluster" title="Direct link to heading">â€‹</a></h3><ul><li>How big should your cluster be?</li><li>Which version of Kubernetes should you run?</li><li>What DNS zone should you use?</li><li>What SKU tier should your cluster have?</li><li>What size should your k8s nodes have?</li></ul><p>All of this is configured under <code>aks/variables/prod.tfvars</code>.</p><div class="codeBlockContainer_I0IT language-prod.tfvars theme-code-block"><div class="codeBlockContent_wNvx prod.tfvars"><pre tabindex="0" class="prism-code language-prod.tfvars codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">environment = &quot;prod&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">dns_zone    = &quot;prod.aks.xenit.io&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">aks_config = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  kubernetes_version = &quot;1.20.7&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  sku_tier           = &quot;Free&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  default_node_pool = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    orchestrator_version = &quot;1.20.7&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vm_size              = &quot;Standard_D2as_v4&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    min_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    max_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    node_labels          = {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  additional_node_pools = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name                 = &quot;standard2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      orchestrator_version = &quot;1.20.7&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      vm_size              = &quot;Standard_D2as_v4&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      min_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      max_count            = 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_labels          = {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_taints          = []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>Notice the vm_size = Standard_D2as_v4</p></blockquote><h3 class="anchor anchorWithStickyNavbar_mojV" id="gitops-using-flux">GitOps using Flux<a class="hash-link" href="#gitops-using-flux" title="Direct link to heading">â€‹</a></h3><p>If you want Flux to manage your GitOps repo from the get go you can enable this in <code>aks/variables/common.tfvars</code>.
In my case I will have Flux manage a namespace called monitor and sync a repo under <code>monitor-gitops</code>.</p><p>You need to create the repository in Azure Devops that you link to before applying this Terraform.
The repository can be empty.</p><p>You will also need to create a separate repository for <code>fleet-infra</code>, this repo is used to store Flux config.</p><blockquote><p>This repo cannot be empty and needs a README file or something similar to work as intended before you run Terraform.</p></blockquote><p>In the example below we are using Azure DevOps as our CSM system, but we also support GitHub.
If you want to use GitHub just fill in its config and make <code>azure_devops</code> empty instead.</p><div class="codeBlockContainer_I0IT language-common.tfvars theme-code-block"><div class="codeBlockContent_wNvx common.tfvars"><pre tabindex="0" class="prism-code language-common.tfvars codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespaces = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name                    = &quot;monitor&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    delegate_resource_group = true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;terraform&quot; = &quot;true&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    flux = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      enabled = true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      azure_devops = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        org  = &quot;organization1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proj = &quot;project1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        repo = &quot;monitor-gitops&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      github = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        repo = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-cicd">Terraform CI/CD<a class="hash-link" href="#terraform-cicd" title="Direct link to heading">â€‹</a></h2><p>We have one CI/CD pipeline per terraform directory.
You can find ready to use pipelines under <code>.ci/</code> in the Terraform repo.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-service-principal">Configure service principal<a class="hash-link" href="#configure-service-principal" title="Direct link to heading">â€‹</a></h3><p>There are a few manual steps that you need to perform before we can start to configure the CI/CD pipeline.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="service-principal-access">Service principal access<a class="hash-link" href="#service-principal-access" title="Direct link to heading">â€‹</a></h4><p>A couple of manual steps are required before Terraform can be applied. A main service principal has to be created in the tenants Azure AD, as it will be used by the Terraform modules.</p><p>Create the new service principal. It should have a name with the format <code>sp-sub-&lt;subscription_name&gt;-all-owner</code>. Most likely the subscription name will be <code>xks</code>.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AZ_APP_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sp-sub-&lt;subscription_name&gt;-all-owner&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AZ_APP_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">az ad app create --display-name $</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token variable" style="color:rgb(191, 199, 213)">AZ_APP_NAME</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token variable" style="color:rgb(191, 199, 213)"> --sign-in-audience AzureADMyOrg --query appId -o tsv</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AZ_APP_OBJECT_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">az ad app show --id $</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token variable" style="color:rgb(191, 199, 213)">AZ_APP_ID</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token variable" style="color:rgb(191, 199, 213)"> --output tsv --query </span><span class="token variable function" style="color:rgb(130, 170, 255)">id</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad sp create --id </span><span class="token variable" style="color:rgb(191, 199, 213)">${AZ_APP_OBJECT_ID}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Grant the service principal additional permissions in the App Registration. The permissions <code>Group.ReadWrite.All</code> and <code>Application.ReadWrite.All</code> in Microsoft Graph should be added. After the
permissions are added grant admin consent for the Tenant.</p><p>Make the service principal <code>Owner</code> of all the XKS subscriptions. This is done in the IAM settings of each individual subscription. Additionaly the service principal also needs to be member of the User
administrator role.</p><p>Create three Azure AD groups. These will be used to assing users a owner, contributor, or reader role for all resources..</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad group create --display-name az-sub-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">subscription_name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">-all-owner --mail-nickname az-sub-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">subscription_name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">-all-owner</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad group create --display-name az-sub-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">subscription_name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">-all-contributor --mail-nickname az-sub-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">subscription_name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">-all-contributor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad group create --display-name az-sub-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">subscription_name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">-all-reader --mail-nickname az-sub-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">subscription_name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">-all-reader</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can also view to original documentation on how to <a href="https://github.com/XenitAB/terraform-modules/blob/main/modules/azure/README.md" target="_blank" rel="noopener noreferrer">create a SP</a>.</p><p>In some cases it might be useful to create a group where both a admin group for you as an admin the SP can use and assign the group the needed access.
Depending on how your <code>global.tfvars</code> looks like it will be called something like: <code>az-mg-lz-xks-owner</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="create-service-principal-key">Create Service principal key<a class="hash-link" href="#create-service-principal-key" title="Direct link to heading">â€‹</a></h4><p>The SP that we use is generated by Terraform but we do not store the key anywhere,
so this is among the few times that we have to do something manual.</p><p>First find the SP that you will use, this will depend on your Terraform config.</p><p>There is no CLI command to create a new key so it is done through the portal.</p><p>AAD -&gt; App registrations -&gt; All applications -&gt; <em>search for the application</em> -&gt; Certificates &amp; secrets -&gt; New client secret</p><p>The key is only shown once, so copy it some where safe for long-term storage. This key will be used when creating the service connection in Azure DevOps.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="setup-service-connection">Setup Service Connection<a class="hash-link" href="#setup-service-connection" title="Direct link to heading">â€‹</a></h3><p>To be able to talk from Azure DevOps to Azure and be able to run Terraform on push we need to configure service connections.
Now you will also need the key that we created in the SP earlier.</p><p>Get the config:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Service Principal Id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">APP_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">az ad sp list --display-name sp-sub-xks-all-owner -o tsv --query </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;[].appId&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Tenant ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">TENANT_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">az account show -o tsv --query tenantId</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Subscription Id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">SUB_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">az account show -o tsv --query </span><span class="token variable function" style="color:rgb(130, 170, 255)">id</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In Azure DevOps:
Project settings -&gt; Service connections -&gt; New service connection -&gt; Azure Resource Manager -&gt; Service principal (manual)</p><ul><li>Subscription Id = $SUB_ID</li><li>Service Principal Id = $APP_ID</li><li>Service principal key = The key created in the earlier step</li><li>Tenant ID = $TENANT_ID</li><li>Service connection name = xks-${environment}-owner</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="update-pipelines">Update pipelines<a class="hash-link" href="#update-pipelines" title="Direct link to heading">â€‹</a></h3><p>Update the variable <code>azureSubscriptionTemplate</code>. You can find the value under Project settings -&gt; Service Connections</p><img alt="Service Connections" src="/img/assets/xks/operator-guide/project_settings.png"><p>In my case <code>sp-sub-project1-xks</code>:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Build.BuildId)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azureSubscriptionTemplate</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sp-sub-project1-xks-{0}-owner&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> terraformFolder</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;governance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sourceBranch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;refs/heads/main&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Also update the project path in &quot;name&quot;. Also notice the ref, the ref points to which version of the module that you are using:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">repositories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">repository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> templates</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> git</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> project1/azure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">devops</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">templates</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">ref</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> refs/tags/2021.03.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="add-cicd-pipelines">Add CI/CD pipelines<a class="hash-link" href="#add-cicd-pipelines" title="Direct link to heading">â€‹</a></h3><p>Once again add a pipeline.</p><p>Assuming that you named your repository to Terraform</p><p>Pipelines -&gt; New pipeline -&gt; Azure Repos Git -&gt; Terraform -&gt; Existing Azure Pipelines YAML file</p><p>Import the pipeline from the following path: <code>.ci/pipeline-governance.yaml</code></p><p>Hopefully after adding the pipeline the pipeline should automatically trigger and the plan and apply stages should go through without any problems.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-pat-secret">Create PAT secret<a class="hash-link" href="#create-pat-secret" title="Direct link to heading">â€‹</a></h3><p>To make it possible for flux to clone repos from azure devops we need to create a Personal Access Token(PAT).</p><p>User Settings -&gt; Personal access tokens -&gt; New Token</p><img alt="Settings user" src="/img/assets/xks/operator-guide/settings_user.png"><p>Create a PAT</p><img alt="Create PAT" src="/img/assets/xks/operator-guide/create_pat.png"><p>Copy the generated key, we will need it for the next step.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="add-pat-to-azure-key-vaults">Add PAT to Azure Key Vaults<a class="hash-link" href="#add-pat-to-azure-key-vaults" title="Direct link to heading">â€‹</a></h3><p>To make it possible for terraform to reach the PAT in a easy and secure way we have chosen to store the PAT in Azure Key Vaults which you need to add manually.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="azure-cli">Azure CLI<a class="hash-link" href="#azure-cli" title="Direct link to heading">â€‹</a></h4><p>You can add the secret using the <code>az</code> CLI.</p><p>Call the secret <code>azure-devops-pat</code> and the value should be the token you created in Azure DevOps.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># List all key vaults</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Create the secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault secret </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> --vault-name kv-dev-we-core-1234 --name azure-devops-pat --value </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;SuperSecretToken123&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="azure-portal">Azure portal<a class="hash-link" href="#azure-portal" title="Direct link to heading">â€‹</a></h4><p>Or if you prefer use the UI.</p><p>In the Azure portal search for &quot;Key vaults&quot; and pick the core one that matches the unique_suffix that you have specified in <code>global.tfvars</code>, in our case 1234.</p><p>Key vaults -&gt; core-1234 -&gt; Secrets -&gt; Generate/Import</p><img alt="Azure Key Vaults" src="/img/assets/xks/operator-guide/azure_key_vault.jpg"><p>Call the secret <code>azure-devops-pat</code> and add the PAT key that you created in the previous step.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="admin-and-developer-access">Admin and developer access<a class="hash-link" href="#admin-and-developer-access" title="Direct link to heading">â€‹</a></h2><p>Hopefully you should now have one XKS cluster up and running, but currently no developer can actually reach the cluster.</p><p>In XKF we see clusters as cattle and at any time we can decide to recreate an XKS cluster.
To be able to do this without our developers even knowing we use blue green clusters. TODO write a document on how blue green clusters works and link.
We use GitOps together with DNS to be able to migrate applications without any impact to end-users assuming that our developers have written 12 step applications.
To store state we utilize the cloud services available in the different clouds that XKF supports.</p><p>To make sure that our developers do not notice when we change our the cluster we have written a Kubernetes API Proxy called <a href="https://github.com/XenitAB/azad-kube-proxy" target="_blank" rel="noopener noreferrer">azad-kube-proxy</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="azure-ad-kubernetes-proxy">Azure AD Kubernetes Proxy<a class="hash-link" href="#azure-ad-kubernetes-proxy" title="Direct link to heading">â€‹</a></h3><p>AZAD as we also call it, is a deployment that runs inside XKS and sits in front of the Kubernetes API.</p><p>We also supply a krew/kubectl plugin to make it easy for our developers to use AZAD.
For instructions on how to setup and configure this <a href="https://github.com/XenitAB/azad-kube-proxy" target="_blank" rel="noopener noreferrer">see</a>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="azad-usage">AZAD Usage<a class="hash-link" href="#azad-usage" title="Direct link to heading">â€‹</a></h4><p>Install krew: <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows" target="_blank" rel="noopener noreferrer">https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows</a>
Install the azad-proxy plugin: <code>kubectl krew install azad-proxy</code>
Login with the Azure CLI (a valid session with azure cli is always required): <code>az login</code>
List all the available clusters: <code>kubectl azad-proxy menu</code></p><p>You can also use the discover function:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl azad-proxy discover</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl azad-proxy generate --cluster-name dev-cluster --proxy-url https://dev.example.com --resource https://dev.example.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="aad-groups">AAD groups<a class="hash-link" href="#aad-groups" title="Direct link to heading">â€‹</a></h3><p>To make it possible for our developers and admins to actually login to the cluster we need to add them to a AAD group.</p><p>If you are a AAD guest user you need to add the AAD Role: <strong>Directory Reader</strong> to your user account.
AZAD proxy parses the AAD and that is why the user needs Directory Reader.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="no-subscription">No subscription<a class="hash-link" href="#no-subscription" title="Direct link to heading">â€‹</a></h4><p>If you have not gotten any of the RG groups that XKF generates and perform <code>az login</code> you might see an error
saying that you do not have any subscriptions.</p><p>This is more likely if you are running XKF in AWS but also possible in Azure.
Do as the error suggest and use the <code>--allow-no-subscription</code> flag.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># The variable TENANT_ID = your tenant id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az login </span><span class="token variable" style="color:rgb(191, 199, 213)">$TENANT_ID</span><span class="token plain"> --allow-no-subscription</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>AZAD proxy should still work.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="developer-groups">Developer groups<a class="hash-link" href="#developer-groups" title="Direct link to heading">â€‹</a></h4><p>Depending on what configuration you did in <code>global.tfvars</code> this will differ but the group name should be something like bellow.</p><p>This group will give your developers contributor access in the namespaces where they have access.</p><p><code>&lt;azure_ad_group_prefix&gt;-rg-xks-&lt;cluster-env&gt;-aks-contributor</code></p><p>Example: <code>az-rg-xks-dev-aks-contributor</code></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="admin-groups">Admin groups<a class="hash-link" href="#admin-groups" title="Direct link to heading">â€‹</a></h4><p>To make it easy for you as a admin you should also use AZAD.</p><p>To give yourself cluster-admin access:</p><p><code>&lt;azure_ad_group_prefix&gt;-xks-&lt;cluster-env&gt;-clusteradmin</code></p><p>Example: <code>aks-xks-dev-clusteradmin</code></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="verify-access">Verify access<a class="hash-link" href="#verify-access" title="Direct link to heading">â€‹</a></h4><p>There is a flag in Kubernetes called <code>--as</code>, which enables you to see if a specific user got access to a specific resource.</p><blockquote><p>Note this will not work if you are connecting to the cluster using AZAD-proxy due to it using the <code>--as</code> flag to run the commands for you.</p></blockquote><p>Since we are using OIDC we also need to provide the group id, you can find the group id in AAD.
You can find the UUID of the group in AAD.</p><p><code>kubectl get pods --as-group=12345678-1234-1234-1234-00000000000 --as=&quot;fake&quot;</code></p><p>If you already have a rolebinding where a existing UUID exist you can run the following command:</p><p><code>kubectl get pods --as-group=$(kubectl get rolebinding &lt;rolebiding-name&gt; -o jsonpath=&#x27;{.subjects[0].name}&#x27;) --as=&quot;fake&quot;</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="authorized-ips">Authorized IPs<a class="hash-link" href="#authorized-ips" title="Direct link to heading">â€‹</a></h3><p>To minimize the exposure of the XKS clusters we define a list of authorized IP:s that is approved to connect the Kubernetes cluster API.</p><p>We need to approve multiple infrastructure networks and user networks.</p><ul><li>If you are using the HUB module and you are running VMSS Azure Devops Agent you need to approve those IP:s as authorized.</li><li>The AKS public IP</li><li>Your developers&#x27; public IP</li></ul><p>A recommendation is to add a comment with what IP you have added.</p><p>aks_authorized_ips = <!-- -->[
&quot;8.8.8.8/32&quot;, # google dns
&quot;1.2.3.4/32&quot;, # developer x ip
&quot;2.3.4.5/30&quot;, # AKS0 dev
]</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/getting-started.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xks/operator-guide/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/xks/operator-guide/agents"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Agents</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bootstrap" class="table-of-contents__link toc-highlight">Bootstrap</a></li><li><a href="#add-new-tenant" class="table-of-contents__link toc-highlight">Add New Tenant</a><ul><li><a href="#import-azure-devops-templates-pipeline" class="table-of-contents__link toc-highlight">Import azure-devops-templates pipeline</a></li><li><a href="#setup-xks" class="table-of-contents__link toc-highlight">Setup XKS</a></li><li><a href="#create-terraform-repo" class="table-of-contents__link toc-highlight">Create Terraform repo</a></li><li><a href="#update-repo" class="table-of-contents__link toc-highlight">Update repo</a></li><li><a href="#create-terraform-storage" class="table-of-contents__link toc-highlight">Create Terraform storage</a></li><li><a href="#configure-governance" class="table-of-contents__link toc-highlight">Configure governance</a></li><li><a href="#configure-core" class="table-of-contents__link toc-highlight">Configure core</a></li><li><a href="#configure-aks-cluster" class="table-of-contents__link toc-highlight">Configure AKS cluster</a></li><li><a href="#gitops-using-flux" class="table-of-contents__link toc-highlight">GitOps using Flux</a></li></ul></li><li><a href="#terraform-cicd" class="table-of-contents__link toc-highlight">Terraform CI/CD</a><ul><li><a href="#configure-service-principal" class="table-of-contents__link toc-highlight">Configure service principal</a></li><li><a href="#setup-service-connection" class="table-of-contents__link toc-highlight">Setup Service Connection</a></li><li><a href="#update-pipelines" class="table-of-contents__link toc-highlight">Update pipelines</a></li><li><a href="#add-cicd-pipelines" class="table-of-contents__link toc-highlight">Add CI/CD pipelines</a></li><li><a href="#create-pat-secret" class="table-of-contents__link toc-highlight">Create PAT secret</a></li><li><a href="#add-pat-to-azure-key-vaults" class="table-of-contents__link toc-highlight">Add PAT to Azure Key Vaults</a></li></ul></li><li><a href="#admin-and-developer-access" class="table-of-contents__link toc-highlight">Admin and developer access</a><ul><li><a href="#azure-ad-kubernetes-proxy" class="table-of-contents__link toc-highlight">Azure AD Kubernetes Proxy</a></li><li><a href="#aad-groups" class="table-of-contents__link toc-highlight">AAD groups</a></li><li><a href="#authorized-ips" class="table-of-contents__link toc-highlight">Authorized IPs</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.2c69eb5d.js"></script>
<script src="/assets/js/main.e8f9d7a3.js"></script>
</body>
</html>