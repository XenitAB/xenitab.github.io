<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-xks/operator-guide/getting-started" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Getting Started | Xenit</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-rh="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-rh="true" property="og:url" content="http://xenitab.github.io/docs/xks/operator-guide/getting-started"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Getting Started | Xenit"><meta data-rh="true" name="description" content="Bootstrap"><meta data-rh="true" property="og:description" content="Bootstrap"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://xenitab.github.io/docs/xks/operator-guide/getting-started"><link data-rh="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/getting-started" hreflang="en"><link data-rh="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/getting-started" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Getting Started","item":"http://xenitab.github.io/docs/xks/operator-guide/getting-started"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.835dd407.css">
<script src="/assets/js/runtime~main.b2f95f14.js" defer="defer"></script>
<script src="/assets/js/main.50de46a3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/xks/"><span title="Xenit Kubernetes Service" class="categoryLinkLabel_W154">Xenit Kubernetes Service</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design"><span title="Architecture and design" class="linkLabel_WmDU">Architecture and design</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/xks/developer-guide/introduction"><span title="Developer Guide" class="categoryLinkLabel_W154">Developer Guide</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/xks/operator-guide/"><span title="Operator Guide" class="categoryLinkLabel_W154">Operator Guide</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/getting-started"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/agents"><span title="Agents" class="linkLabel_WmDU">Agents</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/networking"><span title="Networking" class="linkLabel_WmDU">Networking</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blast-radius"><span title="Blast Radius" class="linkLabel_WmDU">Blast Radius</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blue-green"><span title="Blue Green Clusters" class="linkLabel_WmDU">Blue Green Clusters</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/aws-azdo"><span title="AWS azure-devops" class="linkLabel_WmDU">AWS azure-devops</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/github"><span title="XKF on Github" class="linkLabel_WmDU">XKF on Github</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/cve"><span title="CVE Information" class="linkLabel_WmDU">CVE Information</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/xks/operator-guide/kubernetes/aks"><span title="Kubernetes" class="categoryLinkLabel_W154">Kubernetes</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/xks/operator-guide/ingress-nginx deprecation/ingress-nginx-retiring"><span title="Deprecation ingress-nginx " class="categoryLinkLabel_W154">Deprecation ingress-nginx </span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/xenit-style-guide/containers"><span title="Xenit Style Guide" class="categoryLinkLabel_W154">Xenit Style Guide</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Xenit Kubernetes Service</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Operator Guide</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Getting Started</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Getting Started</h1></header><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="bootstrap">Bootstrap<a href="#bootstrap" class="hash-link" aria-label="Direct link to Bootstrap" title="Direct link to Bootstrap" translate="no">​</a></h2>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="add-new-tenant">Add New Tenant<a href="#add-new-tenant" class="hash-link" aria-label="Direct link to Add New Tenant" title="Direct link to Add New Tenant" translate="no">​</a></h2>
<p>When creating a new tenant there are a number of (for now manual) processes to perform.</p>
<p>In this scenario we are assuming that you are using Azure DevOps and that you have already created a project and organization.</p>
<p>In many places in the text we have provided names, they are just examples, all of these names can be exchanged to fit your needs. In this case let us call it <code>project1</code>. In the future we should manually import a repository.
<a href="https://github.com/XenitAB/azure-devops-templates" target="_blank" rel="noopener noreferrer" class="">https://github.com/XenitAB/azure-devops-templates</a></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="import-azure-devops-templates-pipeline">Import azure-devops-templates pipeline<a href="#import-azure-devops-templates-pipeline" class="hash-link" aria-label="Direct link to Import azure-devops-templates pipeline" title="Direct link to Import azure-devops-templates pipeline" translate="no">​</a></h3>
<p>To make sure that the <code>azure-devops-templates</code> repo is up to date we have an automatic CI that fetches updates from upstream to your local Azure DevOps clone.</p>
<p>Go to pipelines -&gt; New pipeline -&gt; Azure Repos Git -&gt; azure-devops-templates -&gt; Existing Azure Pipelines YAML file</p>
<p>Import the pipeline from the following path: <code>/.ci/pipeline.yaml</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-xks">Setup XKS<a href="#setup-xks" class="hash-link" aria-label="Direct link to Setup XKS" title="Direct link to Setup XKS" translate="no">​</a></h3>
<p>In this case we will only setup a single XKS cluster in one environment, in our case dev. It is easy to add more environments when you have created your first one.</p>
<p>At Xenit we are using Terraform modules that we share <a href="https://github.com/XenitAB/terraform-modules" target="_blank" rel="noopener noreferrer" class="">upstream</a></p>
<p>To setup XKS we will utilize 4 modules:</p>
<ul>
<li class="">governance-global</li>
<li class="">governance-regional</li>
<li class="">core</li>
<li class="">aks</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-terraform-repo">Create Terraform repo<a href="#create-terraform-repo" class="hash-link" aria-label="Direct link to Create Terraform repo" title="Direct link to Create Terraform repo" translate="no">​</a></h3>
<p>Of course we need a place to store our Terraform code so create one in your Azure DevOps organization.
TODO create a example repo that uses our Terraform modules.</p>
<p>You can today see a example of the <a href="https://github.com/XenitAB/github-actions/blob/main/docker/template/Makefile" target="_blank" rel="noopener noreferrer" class="">Makefile</a>.</p>
<p>This is how we normally <a href="https://www.terraform.io/docs/language/modules/develop/structure.html" target="_blank" rel="noopener noreferrer" class="">structure</a> our tenant repo.</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── aks</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── outputs.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── common.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── dev.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── prod.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   └── qa.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   └── variables.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── core</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── outputs.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── common.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── dev.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── prod.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   └── qa.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   └── variables.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── global.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── governance</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── main.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── outputs.tf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── common.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── dev.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   ├── prod.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   │   └── qa.tfvars</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   └── variables.tf</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="update-repo">Update repo<a href="#update-repo" class="hash-link" aria-label="Direct link to Update repo" title="Direct link to Update repo" translate="no">​</a></h3>
<p>We need to update a number of settings in a number of places in your Terraform repo.</p>
<p>Generate a SUFFIX that should be tfstate + a few random numbers, for example <code>tfstate1234</code>.</p>
<p>Update the Makefile SUFFIX variable with the suffix and the random number.</p>
<p>Also update global.tfvars with the same random number.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-terraform-storage">Create Terraform storage<a href="#create-terraform-storage" class="hash-link" aria-label="Direct link to Create Terraform storage" title="Direct link to Create Terraform storage" translate="no">​</a></h3>
<p>In order to store a Terraform state we need to prepare that.</p>
<p>We have written a small Go tool that will help out with <a href="https://github.com/XenitAB/github-actions/tree/main/docker/go-tf-prepare" target="_blank" rel="noopener noreferrer" class="">that</a>.</p>
<p>Instead of running these scripts manually we will use the makefile.</p>
<p>We use one Terrafrom state per <code>DIR</code> and <code>ENV</code>.
Lets create the first Terraform state, in this case governance.</p>
<p><code>make prepare ENV=dev DIR=governance</code></p>
<p>You will need to run the prepare command for each separate Terraform folder.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-governance">Configure governance<a href="#configure-governance" class="hash-link" aria-label="Direct link to Configure governance" title="Direct link to Configure governance" translate="no">​</a></h3>
<p>After defining the variables and you have have applied your config:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">make plan ENV=dev DIR=governance</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># If everything looks good</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">make apply ENV=dev DIR=governance</span><br></span></code></pre></div></div>
<p>By default you don&#x27;t get access to the key vaults that governance creates.
You should probably give the access to a group that you and your team have access to but to get started you can run the following.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">AZ_ID=$(az ad user show --id &quot;your@email&quot; --output tsv --query id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">KEYVAULTNAME=kv-favorite-name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault set-policy --name $KEYVAULTNAME --object-id $AZ_ID --secret-permissions backup delete get list purge recover restore set --key-permissions backup create decrypt delete encrypt get import list purge recover restore sign unwrapKey update verify wrapKey --certificate-permissions backup create delete deleteissuers get getissuers import list listissuers managecontacts manageissuers purge recover restore setissuers update</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-core">Configure core<a href="#configure-core" class="hash-link" aria-label="Direct link to Configure core" title="Direct link to Configure core" translate="no">​</a></h3>
<p>Get a CIDR network for your AKS env per env.
Define in <code>core/variables/env.tfvars</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-aks-cluster">Configure AKS cluster<a href="#configure-aks-cluster" class="hash-link" aria-label="Direct link to Configure AKS cluster" title="Direct link to Configure AKS cluster" translate="no">​</a></h3>
<ul>
<li class="">How big should your cluster be?</li>
<li class="">Which version of Kubernetes should you run?</li>
<li class="">What DNS zone should you use?</li>
<li class="">What SKU tier should your cluster have?</li>
<li class="">What size should your k8s nodes have?</li>
</ul>
<p>All of this is configured under <code>aks/variables/prod.tfvars</code>.</p>
<div class="language-prod.tfvars codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-prod.tfvars codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">environment = &quot;prod&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">dns_zone    = &quot;prod.aks.xenit.io&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">aks_config = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  kubernetes_version = &quot;1.20.7&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  sku_tier           = &quot;Free&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  default_node_pool = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    orchestrator_version = &quot;1.20.7&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vm_size              = &quot;Standard_D2as_v4&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    min_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    max_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    node_labels          = {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  additional_node_pools = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name                 = &quot;standard2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      orchestrator_version = &quot;1.20.7&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      vm_size              = &quot;Standard_D2as_v4&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      min_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      max_count            = 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_labels          = {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_taints          = []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<blockquote>
<p>Notice the vm_size = Standard_D2as_v4</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="gitops-using-flux">GitOps using Flux<a href="#gitops-using-flux" class="hash-link" aria-label="Direct link to GitOps using Flux" title="Direct link to GitOps using Flux" translate="no">​</a></h3>
<p>If you want Flux to manage your GitOps repo from the get go you can enable this in <code>aks/variables/common.tfvars</code>.
In my case I will have Flux manage a namespace called monitor and sync a repo under <code>monitor-gitops</code>.</p>
<p>You need to create the repository in Azure Devops that you link to before applying this Terraform.
The repository can be empty.</p>
<p>You will also need to create a separate repository for <code>fleet-infra</code>, this repo is used to store Flux config.</p>
<blockquote>
<p>This repo cannot be empty and needs a README file or something similar to work as intended before you run Terraform.</p>
</blockquote>
<p>In the example below we are using Azure DevOps as our CSM system, but we also support GitHub.
If you want to use GitHub just fill in its config and make <code>azure_devops</code> empty instead.</p>
<div class="language-common.tfvars codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-common.tfvars codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespaces = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name                    = &quot;monitor&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    delegate_resource_group = true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;terraform&quot; = &quot;true&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    flux = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      enabled = true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      azure_devops = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        org  = &quot;organization1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proj = &quot;project1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        repo = &quot;monitor-gitops&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      github = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        repo = &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="terraform-cicd">Terraform CI/CD<a href="#terraform-cicd" class="hash-link" aria-label="Direct link to Terraform CI/CD" title="Direct link to Terraform CI/CD" translate="no">​</a></h2>
<p>We have one CI/CD pipeline per terraform directory.
You can find ready to use pipelines under <code>.ci/</code> in the Terraform repo.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-service-principal">Configure service principal<a href="#configure-service-principal" class="hash-link" aria-label="Direct link to Configure service principal" title="Direct link to Configure service principal" translate="no">​</a></h3>
<p>There are a few manual steps that you need to perform before we can start to configure the CI/CD pipeline.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="service-principal-access">Service principal access<a href="#service-principal-access" class="hash-link" aria-label="Direct link to Service principal access" title="Direct link to Service principal access" translate="no">​</a></h4>
<p>A couple of manual steps are required before Terraform can be applied. A main service principal has to be created in the tenants Azure AD, as it will be used by the Terraform modules.</p>
<p>Create the new service principal. It should have a name with the format <code>sp-sub-&lt;subscription_name&gt;-all-owner</code>. Most likely the subscription name will be <code>xks</code>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">AZ_APP_NAME=&quot;sp-sub-&lt;subscription_name&gt;-all-owner&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AZ_APP_ID=$(az ad app create --display-name ${AZ_APP_NAME} --sign-in-audience AzureADMyOrg --query appId -o tsv)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AZ_APP_OBJECT_ID=$(az ad app show --id ${AZ_APP_ID} --output tsv --query id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad sp create --id ${AZ_APP_OBJECT_ID}</span><br></span></code></pre></div></div>
<p>Grant the service principal additional permissions in the App Registration. The permissions <code>Group.ReadWrite.All</code> and <code>Application.ReadWrite.All</code> in Microsoft Graph should be added. After the
permissions are added grant admin consent for the Tenant.</p>
<p>Make the service principal <code>Owner</code> of all the XKS subscriptions. This is done in the IAM settings of each individual subscription. Additionaly the service principal also needs to be member of the User
administrator role.</p>
<p>Create three Azure AD groups. These will be used to assing users a owner, contributor, or reader role for all resources..</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad group create --display-name az-sub-&lt;subscription_name&gt;-all-owner --mail-nickname az-sub-&lt;subscription_name&gt;-all-owner</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad group create --display-name az-sub-&lt;subscription_name&gt;-all-contributor --mail-nickname az-sub-&lt;subscription_name&gt;-all-contributor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az ad group create --display-name az-sub-&lt;subscription_name&gt;-all-reader --mail-nickname az-sub-&lt;subscription_name&gt;-all-reader</span><br></span></code></pre></div></div>
<p>You can also view to original documentation on how to <a href="https://github.com/XenitAB/terraform-modules/blob/main/modules/azure/README.md" target="_blank" rel="noopener noreferrer" class="">create a SP</a>.</p>
<p>In some cases it might be useful to create a group where both a admin group for you as an admin the SP can use and assign the group the needed access.
Depending on how your <code>global.tfvars</code> looks like it will be called something like: <code>az-mg-lz-xks-owner</code>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-service-principal-key">Create Service principal key<a href="#create-service-principal-key" class="hash-link" aria-label="Direct link to Create Service principal key" title="Direct link to Create Service principal key" translate="no">​</a></h4>
<p>The SP that we use is generated by Terraform but we do not store the key anywhere,
so this is among the few times that we have to do something manual.</p>
<p>First find the SP that you will use, this will depend on your Terraform config.</p>
<p>There is no CLI command to create a new key so it is done through the portal.</p>
<p>AAD -&gt; App registrations -&gt; All applications -&gt; <em>search for the application</em> -&gt; Certificates &amp; secrets -&gt; New client secret</p>
<p>The key is only shown once, so copy it some where safe for long-term storage. This key will be used when creating the service connection in Azure DevOps.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-service-connection">Setup Service Connection<a href="#setup-service-connection" class="hash-link" aria-label="Direct link to Setup Service Connection" title="Direct link to Setup Service Connection" translate="no">​</a></h3>
<p>To be able to talk from Azure DevOps to Azure and be able to run Terraform on push we need to configure service connections.
Now you will also need the key that we created in the SP earlier.</p>
<p>Get the config:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Service Principal Id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_ID=$(az ad sp list --display-name sp-sub-xks-all-owner -o tsv --query &#x27;[].appId&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Tenant ID</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TENANT_ID=$(az account show -o tsv --query tenantId)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Subscription Id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SUB_ID=$(az account show -o tsv --query id)</span><br></span></code></pre></div></div>
<p>In Azure DevOps:
Project settings -&gt; Service connections -&gt; New service connection -&gt; Azure Resource Manager -&gt; Service principal (manual)</p>
<ul>
<li class="">Subscription Id = $SUB_ID</li>
<li class="">Service Principal Id = $APP_ID</li>
<li class="">Service principal key = The key created in the earlier step</li>
<li class="">Tenant ID = $TENANT_ID</li>
<li class="">Service connection name = xks-${environment}-owner</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="update-pipelines">Update pipelines<a href="#update-pipelines" class="hash-link" aria-label="Direct link to Update pipelines" title="Direct link to Update pipelines" translate="no">​</a></h3>
<p>Update the variable <code>azureSubscriptionTemplate</code>. You can find the value under Project settings -&gt; Service Connections</p>
<img alt="Service Connections" src="/img/assets/xks/operator-guide/project_settings.png">
<p>In my case <code>sp-sub-project1-xks</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Build.BuildId)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azureSubscriptionTemplate</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sp-sub-project1-xks-{0}-owner&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> terraformFolder</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;governance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sourceBranch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;refs/heads/main&quot;</span><br></span></code></pre></div></div>
<p>Also update the project path in &quot;name&quot;. Also notice the ref, the ref points to which version of the module that you are using:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">repositories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">repository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> templates</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> git</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> project1/azure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">devops</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">templates</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">ref</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> refs/tags/2021.03.1</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="add-cicd-pipelines">Add CI/CD pipelines<a href="#add-cicd-pipelines" class="hash-link" aria-label="Direct link to Add CI/CD pipelines" title="Direct link to Add CI/CD pipelines" translate="no">​</a></h3>
<p>Once again add a pipeline.</p>
<p>Assuming that you named your repository to Terraform</p>
<p>Pipelines -&gt; New pipeline -&gt; Azure Repos Git -&gt; Terraform -&gt; Existing Azure Pipelines YAML file</p>
<p>Import the pipeline from the following path: <code>.ci/pipeline-governance.yaml</code></p>
<p>Hopefully after adding the pipeline the pipeline should automatically trigger and the plan and apply stages should go through without any problems.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-pat-secret">Create PAT secret<a href="#create-pat-secret" class="hash-link" aria-label="Direct link to Create PAT secret" title="Direct link to Create PAT secret" translate="no">​</a></h3>
<p>To make it possible for flux to clone repos from azure devops we need to create a Personal Access Token(PAT).</p>
<p>User Settings -&gt; Personal access tokens -&gt; New Token</p>
<img alt="Settings user" src="/img/assets/xks/operator-guide/settings_user.png">
<p>Create a PAT</p>
<img alt="Create PAT" src="/img/assets/xks/operator-guide/create_pat.png">
<p>Copy the generated key, we will need it for the next step.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="add-pat-to-azure-key-vaults">Add PAT to Azure Key Vaults<a href="#add-pat-to-azure-key-vaults" class="hash-link" aria-label="Direct link to Add PAT to Azure Key Vaults" title="Direct link to Add PAT to Azure Key Vaults" translate="no">​</a></h3>
<p>To make it possible for terraform to reach the PAT in a easy and secure way we have chosen to store the PAT in Azure Key Vaults which you need to add manually.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="azure-cli">Azure CLI<a href="#azure-cli" class="hash-link" aria-label="Direct link to Azure CLI" title="Direct link to Azure CLI" translate="no">​</a></h4>
<p>You can add the secret using the <code>az</code> CLI.</p>
<p>Call the secret <code>azure-devops-pat</code> and the value should be the token you created in Azure DevOps.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># List all key vaults</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Create the secret</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault secret set --vault-name kv-dev-we-core-1234 --name azure-devops-pat --value &quot;SuperSecretToken123&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="azure-portal">Azure portal<a href="#azure-portal" class="hash-link" aria-label="Direct link to Azure portal" title="Direct link to Azure portal" translate="no">​</a></h4>
<p>Or if you prefer use the UI.</p>
<p>In the Azure portal search for &quot;Key vaults&quot; and pick the core one that matches the unique_suffix that you have specified in <code>global.tfvars</code>, in our case 1234.</p>
<p>Key vaults -&gt; core-1234 -&gt; Secrets -&gt; Generate/Import</p>
<img alt="Azure Key Vaults" src="/img/assets/xks/operator-guide/azure_key_vault.jpg">
<p>Call the secret <code>azure-devops-pat</code> and add the PAT key that you created in the previous step.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="admin-and-developer-access">Admin and developer access<a href="#admin-and-developer-access" class="hash-link" aria-label="Direct link to Admin and developer access" title="Direct link to Admin and developer access" translate="no">​</a></h2>
<p>Hopefully you should now have one XKS cluster up and running, but currently no developer can actually reach the cluster.</p>
<p>In XKF we see clusters as cattle and at any time we can decide to recreate an XKS cluster.
To be able to do this without our developers even knowing we use blue green clusters. TODO write a document on how blue green clusters works and link.
We use GitOps together with DNS to be able to migrate applications without any impact to end-users assuming that our developers have written 12 step applications.
To store state we utilize the cloud services available in the different clouds that XKF supports.</p>
<p>To make sure that our developers do not notice when we change our the cluster we have written a Kubernetes API Proxy called <a href="https://github.com/XenitAB/azad-kube-proxy" target="_blank" rel="noopener noreferrer" class="">azad-kube-proxy</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="azure-ad-kubernetes-proxy">Azure AD Kubernetes Proxy<a href="#azure-ad-kubernetes-proxy" class="hash-link" aria-label="Direct link to Azure AD Kubernetes Proxy" title="Direct link to Azure AD Kubernetes Proxy" translate="no">​</a></h3>
<p>AZAD as we also call it, is a deployment that runs inside XKS and sits in front of the Kubernetes API.</p>
<p>We also supply a krew/kubectl plugin to make it easy for our developers to use AZAD.
For instructions on how to setup and configure this <a href="https://github.com/XenitAB/azad-kube-proxy" target="_blank" rel="noopener noreferrer" class="">see</a>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="azad-usage">AZAD Usage<a href="#azad-usage" class="hash-link" aria-label="Direct link to AZAD Usage" title="Direct link to AZAD Usage" translate="no">​</a></h4>
<p>Install krew: <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows" target="_blank" rel="noopener noreferrer" class="">https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows</a>
Install the azad-proxy plugin: <code>kubectl krew install azad-proxy</code>
Login with the Azure CLI (a valid session with azure cli is always required): <code>az login</code>
List all the available clusters: <code>kubectl azad-proxy menu</code></p>
<p>You can also use the discover function:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl azad-proxy discover</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl azad-proxy generate --cluster-name dev-cluster --proxy-url https://dev.example.com --resource https://dev.example.com</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="aad-groups">AAD groups<a href="#aad-groups" class="hash-link" aria-label="Direct link to AAD groups" title="Direct link to AAD groups" translate="no">​</a></h3>
<p>To make it possible for our developers and admins to actually login to the cluster we need to add them to a AAD group.</p>
<p>If you are a AAD guest user you need to add the AAD Role: <strong>Directory Reader</strong> to your user account.
AZAD proxy parses the AAD and that is why the user needs Directory Reader.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="no-subscription">No subscription<a href="#no-subscription" class="hash-link" aria-label="Direct link to No subscription" title="Direct link to No subscription" translate="no">​</a></h4>
<p>If you have not gotten any of the RG groups that XKF generates and perform <code>az login</code> you might see an error
saying that you do not have any subscriptions.</p>
<p>This is more likely if you are running XKF in AWS but also possible in Azure.
Do as the error suggest and use the <code>--allow-no-subscription</code> flag.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># The variable TENANT_ID = your tenant id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az login $TENANT_ID --allow-no-subscription</span><br></span></code></pre></div></div>
<p>AZAD proxy should still work.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="developer-groups">Developer groups<a href="#developer-groups" class="hash-link" aria-label="Direct link to Developer groups" title="Direct link to Developer groups" translate="no">​</a></h4>
<p>Depending on what configuration you did in <code>global.tfvars</code> this will differ but the group name should be something like bellow.</p>
<p>This group will give your developers contributor access in the namespaces where they have access.</p>
<p><code>&lt;azure_ad_group_prefix&gt;-rg-xks-&lt;cluster-env&gt;-aks-contributor</code></p>
<p>Example: <code>az-rg-xks-dev-aks-contributor</code></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="admin-groups">Admin groups<a href="#admin-groups" class="hash-link" aria-label="Direct link to Admin groups" title="Direct link to Admin groups" translate="no">​</a></h4>
<p>To make it easy for you as a admin you should also use AZAD.</p>
<p>To give yourself cluster-admin access:</p>
<p><code>&lt;azure_ad_group_prefix&gt;-xks-&lt;cluster-env&gt;-clusteradmin</code></p>
<p>Example: <code>aks-xks-dev-clusteradmin</code></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="verify-access">Verify access<a href="#verify-access" class="hash-link" aria-label="Direct link to Verify access" title="Direct link to Verify access" translate="no">​</a></h4>
<p>There is a flag in Kubernetes called <code>--as</code>, which enables you to see if a specific user got access to a specific resource.</p>
<blockquote>
<p>Note this will not work if you are connecting to the cluster using AZAD-proxy due to it using the <code>--as</code> flag to run the commands for you.</p>
</blockquote>
<p>Since we are using OIDC we also need to provide the group id, you can find the group id in AAD.
You can find the UUID of the group in AAD.</p>
<p><code>kubectl get pods --as-group=12345678-1234-1234-1234-00000000000 --as=&quot;fake&quot;</code></p>
<p>If you already have a rolebinding where a existing UUID exist you can run the following command:</p>
<p><code>kubectl get pods --as-group=$(kubectl get rolebinding &lt;rolebiding-name&gt; -o jsonpath=&#x27;{.subjects[0].name}&#x27;) --as=&quot;fake&quot;</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="authorized-ips">Authorized IPs<a href="#authorized-ips" class="hash-link" aria-label="Direct link to Authorized IPs" title="Direct link to Authorized IPs" translate="no">​</a></h3>
<p>To minimize the exposure of the XKS clusters we define a list of authorized IP<!-- -->:s<!-- --> that is approved to connect the Kubernetes cluster API.</p>
<p>We need to approve multiple infrastructure networks and user networks.</p>
<ul>
<li class="">If you are using the HUB module and you are running VMSS Azure Devops Agent you need to approve those IP<!-- -->:s<!-- --> as authorized.</li>
<li class="">The AKS public IP</li>
<li class="">Your developers&#x27; public IP</li>
</ul>
<p>A recommendation is to add a comment with what IP you have added.</p>
<p>aks_authorized_ips = [
&quot;8.8.8.8/32&quot;, # google dns
&quot;1.2.3.4/32&quot;, # developer x ip
&quot;2.3.4.5/30&quot;, # AKS0 dev
]</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/getting-started.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/xks/operator-guide/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/xks/operator-guide/agents"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Agents</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bootstrap" class="table-of-contents__link toc-highlight">Bootstrap</a></li><li><a href="#add-new-tenant" class="table-of-contents__link toc-highlight">Add New Tenant</a><ul><li><a href="#import-azure-devops-templates-pipeline" class="table-of-contents__link toc-highlight">Import azure-devops-templates pipeline</a></li><li><a href="#setup-xks" class="table-of-contents__link toc-highlight">Setup XKS</a></li><li><a href="#create-terraform-repo" class="table-of-contents__link toc-highlight">Create Terraform repo</a></li><li><a href="#update-repo" class="table-of-contents__link toc-highlight">Update repo</a></li><li><a href="#create-terraform-storage" class="table-of-contents__link toc-highlight">Create Terraform storage</a></li><li><a href="#configure-governance" class="table-of-contents__link toc-highlight">Configure governance</a></li><li><a href="#configure-core" class="table-of-contents__link toc-highlight">Configure core</a></li><li><a href="#configure-aks-cluster" class="table-of-contents__link toc-highlight">Configure AKS cluster</a></li><li><a href="#gitops-using-flux" class="table-of-contents__link toc-highlight">GitOps using Flux</a></li></ul></li><li><a href="#terraform-cicd" class="table-of-contents__link toc-highlight">Terraform CI/CD</a><ul><li><a href="#configure-service-principal" class="table-of-contents__link toc-highlight">Configure service principal</a></li><li><a href="#setup-service-connection" class="table-of-contents__link toc-highlight">Setup Service Connection</a></li><li><a href="#update-pipelines" class="table-of-contents__link toc-highlight">Update pipelines</a></li><li><a href="#add-cicd-pipelines" class="table-of-contents__link toc-highlight">Add CI/CD pipelines</a></li><li><a href="#create-pat-secret" class="table-of-contents__link toc-highlight">Create PAT secret</a></li><li><a href="#add-pat-to-azure-key-vaults" class="table-of-contents__link toc-highlight">Add PAT to Azure Key Vaults</a></li></ul></li><li><a href="#admin-and-developer-access" class="table-of-contents__link toc-highlight">Admin and developer access</a><ul><li><a href="#azure-ad-kubernetes-proxy" class="table-of-contents__link toc-highlight">Azure AD Kubernetes Proxy</a></li><li><a href="#aad-groups" class="table-of-contents__link toc-highlight">AAD groups</a></li><li><a href="#authorized-ips" class="table-of-contents__link toc-highlight">Authorized IPs</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>