<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-xks/operator-guide/networking" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Networking | Xenit</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-rh="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-rh="true" property="og:url" content="http://xenitab.github.io/docs/xks/operator-guide/networking"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Networking | Xenit"><meta data-rh="true" name="description" content="There are a lot of moving parts when looking at networking and Kubernetes. There are both Kubernetes specific components such as kube-proxy and CoreDNS but also cloud specific components such as the"><meta data-rh="true" property="og:description" content="There are a lot of moving parts when looking at networking and Kubernetes. There are both Kubernetes specific components such as kube-proxy and CoreDNS but also cloud specific components such as the"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://xenitab.github.io/docs/xks/operator-guide/networking"><link data-rh="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/networking" hreflang="en"><link data-rh="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/networking" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Networking","item":"http://xenitab.github.io/docs/xks/operator-guide/networking"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.835dd407.css">
<script src="/assets/js/runtime~main.b2f95f14.js" defer="defer"></script>
<script src="/assets/js/main.50de46a3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/xks/"><span title="Xenit Kubernetes Service" class="categoryLinkLabel_W154">Xenit Kubernetes Service</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design"><span title="Architecture and design" class="linkLabel_WmDU">Architecture and design</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/xks/developer-guide/introduction"><span title="Developer Guide" class="categoryLinkLabel_W154">Developer Guide</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/xks/operator-guide/"><span title="Operator Guide" class="categoryLinkLabel_W154">Operator Guide</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/getting-started"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/agents"><span title="Agents" class="linkLabel_WmDU">Agents</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/networking"><span title="Networking" class="linkLabel_WmDU">Networking</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blast-radius"><span title="Blast Radius" class="linkLabel_WmDU">Blast Radius</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blue-green"><span title="Blue Green Clusters" class="linkLabel_WmDU">Blue Green Clusters</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/aws-azdo"><span title="AWS azure-devops" class="linkLabel_WmDU">AWS azure-devops</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/github"><span title="XKF on Github" class="linkLabel_WmDU">XKF on Github</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/cve"><span title="CVE Information" class="linkLabel_WmDU">CVE Information</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/xks/operator-guide/kubernetes/aks"><span title="Kubernetes" class="categoryLinkLabel_W154">Kubernetes</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/xks/operator-guide/ingress-nginx deprecation/ingress-nginx-retiring"><span title="Deprecation ingress-nginx " class="categoryLinkLabel_W154">Deprecation ingress-nginx </span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/xenit-style-guide/containers"><span title="Xenit Style Guide" class="categoryLinkLabel_W154">Xenit Style Guide</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Xenit Kubernetes Service</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Operator Guide</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Networking</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Networking</h1></header><p>There are a lot of moving parts when looking at networking and Kubernetes. There are both Kubernetes specific components such as kube-proxy and CoreDNS but also cloud specific components such as the
underlying VNET/VPC, load balancer, and NAT gateways. The page aims to describe the architecture and some of the limitations and problems which can be experienced when working with XKS to help with
debugging networking issues.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="kubernetes">Kubernetes<a href="#kubernetes" class="hash-link" aria-label="Direct link to Kubernetes" title="Direct link to Kubernetes" translate="no">​</a></h2>
<p>TBD</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="node-local-dns">Node Local DNS<a href="#node-local-dns" class="hash-link" aria-label="Direct link to Node Local DNS" title="Direct link to Node Local DNS" translate="no">​</a></h3>
<p>To lower DNS query latency and a number of other <a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#motivation" target="_blank" rel="noopener noreferrer" class="">reasons</a>
we are using <a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/" target="_blank" rel="noopener noreferrer" class="">NodeLocal DNS</a> in XKS.</p>
<p>Node Local DNS is an application that runs on each node and creates a loopback interface on each node together with a number of iptables rules. The iptables rules intercepts all the DNS traffic from all pods that is sent to the clusters DNS server.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="node-local-dns-configuration">Node Local DNS Configuration<a href="#node-local-dns-configuration" class="hash-link" aria-label="Direct link to Node Local DNS Configuration" title="Direct link to Node Local DNS Configuration" translate="no">​</a></h4>
<p>To configure Node Local DNS you need to provide two values.
The IP of the central DNS server in your cluster, you can find this by running: <code>kubectl get svc kube-dns -n kube-system -o jsonpath={.spec.clusterIP}</code>.
The second value is a random IP that you know that nothing else in the cluster is ever going to use, in our case we used the example ip <code>169.254.20.10</code>.
These values are defined for you in XKS but it&#x27;s good to know about them and where to find them.</p>
<p>Here you can view the example <a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml" target="_blank" rel="noopener noreferrer" class="">configuration</a> provided in the docs.</p>
<p>Node Local DNS is built on top of CoreDNS and is plugin based. Depending on your needs you can easily enable new features.
By default NodeLocal DNS don&#x27;t log the DNS requests it gets but it can make it hard to debug.</p>
<p>In XKS we haven&#x27;t enabled any debug logs ether but if you need to enable it all you need to do is to add <code>log</code> as part of the plugins defined in your yaml.</p>
<p>For example:</p>
<div class="language-.yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-.yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Corefile: |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .:53 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        errors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        cache 30</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        loop</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        bind 169.254.20.10 10.0.0.10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        forward . __PILLAR__UPSTREAM__SERVERS__</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        prometheus :9253</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span></code></pre></div></div>
<p>For you as a XKS administrator the biggest chance to change is in the <a href="https://coredns.io/plugins/cache/" target="_blank" rel="noopener noreferrer" class="">cache plugin</a>.
Instead of me trying to rewrite the docs I recommend you to read it but we have changed the default value and at the time of writing we use the following config:</p>
<div class="language-.yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-.yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Corefile: |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .:53 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        errors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        cache {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                success 9984 30</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                denial 9984 10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                prefetch 20 60s 15%</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        loop</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        bind 169.254.20.10 10.0.0.10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        forward . /etc/resolv.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        prometheus :9253</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span></code></pre></div></div>
<p>The prefetch feature allows us to automatically get DNS entries that is in the cache and automatically update it before the DNS TTL ends.
Remember that the cache TTL won&#x27;t change the TTL of your cached DNS entries.
If the DNS entry have a TTL of 1 minute and the cache have a TTL of 5 minutes the DNS entry will disappear after 1 minute.</p>
<p>If you for example define a cache without setting success and denial but set the prefetch config the default TTL cache value will still be applied.</p>
<div class="language-.yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-.yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Corefile: |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .:53 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        errors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        cache {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            prefetch 20 60s 15%</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        loop</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        bind 169.254.20.10 10.0.0.10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        forward . /etc/resolv.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        prometheus :9253</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="node-local-dns-networkpolicy">Node local DNS networkpolicy<a href="#node-local-dns-networkpolicy" class="hash-link" aria-label="Direct link to Node local DNS networkpolicy" title="Direct link to Node local DNS networkpolicy" translate="no">​</a></h4>
<p>Sadly when using NodeLocal DNS together with Networkpolicy and the Calico CNI you need to write a networkpolicy that instead of using label selectors on a pod level you need to write a ruler
that will work on the <a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/nodelocaldns/README.md#network-policy-and-dns-connectivity" target="_blank" rel="noopener noreferrer" class="">node level</a>
What it doesn&#x27;t say in the docs is that you need to define the internal vnet IP as well.</p>
<p>These are the same values that was defined when doing the configuration.
The default values on XKS <code>AKS</code> is <code>169.254.20.10</code> and <code>10.0.0.10</code> and on <code>AWS</code> it&#x27;s <code>169.254.20.10</code> and <code>172.20.0.10</code>.</p>
<p>The needed networkpolicy exist by default in all the tenant namespaces and is called <code>default-deny</code> and is managed by terraform.</p>
<p>To view the rule run:</p>
<p><code>kubectl get networkpolicies default-deny -n &lt;tenant&gt;</code></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="azure">Azure<a href="#azure" class="hash-link" aria-label="Direct link to Azure" title="Direct link to Azure" translate="no">​</a></h2>
<p>XKS in Azure uses a single VNET with a single subnet per AKS cluster. The VNET and subnets are created by the <a href="https://github.com/XenitAB/terraform-modules/tree/main/modules/azure/core" target="_blank" rel="noopener noreferrer" class="">core module</a>.
Additionally each AKS cluster also creates a load balancer. The load balancer is used for both ingress and egress traffic.</p>
<p>When a Kubernetes service of type <code>LoadBalancer</code> is created a new IP is attached to the load balancer. An Azure load balancer can have multiple IPs attached to it so unlike AWS it does not have to
create a new load balancer.</p>
<p>During the creation of the AKS cluster a public IP prefix is attached to the load balancer for egress traffic. This ensures that all traffic egress with the same source IP, enabling the use of IP
white listing in external sources. This does however mean that all outbound traffic will also go through the same load balancer as the incoming traffic. There is currently work underway to enable the
use of managed NAT gateways for egress traffic in AKS, but it is currently <a href="https://docs.microsoft.com/en-us/azure/aks/nat-gateway" target="_blank" rel="noopener noreferrer" class="">in preview</a> right now.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="snat-exhaustion">SNAT Exhaustion<a href="#snat-exhaustion" class="hash-link" aria-label="Direct link to SNAT Exhaustion" title="Direct link to SNAT Exhaustion" translate="no">​</a></h3>
<p>Applications making large numbers of outgoing TCP or UDP connections to the same IP and port can cause an issue known as <em>SNAT port exhaustion</em>. This is mostly due to the network architecture in Azure
and AKS. All of the outgoing traffic from AKS goes through the load balancer, and for each outgoing request the load balancer needs to allocate an SNAT port to receive the response. Each Azure load
balancer will allocate 64000 SNAT ports. This may seem like a lot, but there is a caveat as AKS will limit the amount of SNAT ports per node. The amount of SNAT ports available per node depends on
the amount of nodes per cluster.</p>
<table><thead><tr><th style="text-align:center">Node Count</th><th style="text-align:center">SNAT Ports per Node</th></tr></thead><tbody><tr><td style="text-align:center">1-50</td><td style="text-align:center">1024</td></tr><tr><td style="text-align:center">51-100</td><td style="text-align:center">512</td></tr><tr><td style="text-align:center">101-200</td><td style="text-align:center">256</td></tr><tr><td style="text-align:center">201-400</td><td style="text-align:center">128</td></tr><tr><td style="text-align:center">401-800</td><td style="text-align:center">64</td></tr><tr><td style="text-align:center">801-1000</td><td style="text-align:center">32</td></tr></tbody></table>
<p>A symptom of exhausting the SNAT ports is that outgoing requests will just fail. This is of course not a good situation, and may be hard to debug as a failing request could be caused by many different
factors.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="links">Links<a href="#links" class="hash-link" aria-label="Direct link to Links" title="Direct link to Links" translate="no">​</a></h4>
<ul>
<li class=""><a href="https://docs.microsoft.com/en-us/azure/aks/load-balancer-standard#troubleshooting-snat" target="_blank" rel="noopener noreferrer" class="">https://docs.microsoft.com/en-us/azure/aks/load-balancer-standard#troubleshooting-snat</a></li>
<li class=""><a href="https://docs.microsoft.com/en-us/azure/load-balancer/troubleshoot-outbound-connection" target="_blank" rel="noopener noreferrer" class="">https://docs.microsoft.com/en-us/azure/load-balancer/troubleshoot-outbound-connection</a></li>
<li class=""><a href="https://www.danielstechblog.io/detecting-snat-port-exhaustion-on-azure-kubernetes-service/" target="_blank" rel="noopener noreferrer" class="">https://www.danielstechblog.io/detecting-snat-port-exhaustion-on-azure-kubernetes-service/</a></li>
<li class=""><a href="https://medium.com/asos-techblog/an-aks-performance-journey-part-1-sizing-everything-up-ee6d2346ea99" target="_blank" rel="noopener noreferrer" class="">https://medium.com/asos-techblog/an-aks-performance-journey-part-1-sizing-everything-up-ee6d2346ea99</a></li>
<li class=""><a href="https://medium.com/asos-techblog/an-aks-performance-journey-part-2-networking-it-out-e253f5bb4f69" target="_blank" rel="noopener noreferrer" class="">https://medium.com/asos-techblog/an-aks-performance-journey-part-2-networking-it-out-e253f5bb4f69</a></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="aws">AWS<a href="#aws" class="hash-link" aria-label="Direct link to AWS" title="Direct link to AWS" translate="no">​</a></h2>
<p>TBD</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/networking.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/xks/operator-guide/agents"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Agents</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/xks/operator-guide/blast-radius"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Blast Radius</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kubernetes" class="table-of-contents__link toc-highlight">Kubernetes</a><ul><li><a href="#node-local-dns" class="table-of-contents__link toc-highlight">Node Local DNS</a></li></ul></li><li><a href="#azure" class="table-of-contents__link toc-highlight">Azure</a><ul><li><a href="#snat-exhaustion" class="table-of-contents__link toc-highlight">SNAT Exhaustion</a></li></ul></li><li><a href="#aws" class="table-of-contents__link toc-highlight">AWS</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>