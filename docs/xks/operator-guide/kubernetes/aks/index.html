<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><title data-react-helmet="true">AKS | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/xks/operator-guide/kubernetes/aks"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="AKS | Xenit"><meta data-react-helmet="true" name="description" content="System Node Pool"><meta data-react-helmet="true" property="og:description" content="System Node Pool"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/xks/operator-guide/kubernetes/aks"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/kubernetes/aks" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/operator-guide/kubernetes/aks" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.018923a1.css">
<link rel="preload" href="/assets/js/runtime~main.2c69eb5d.js" as="script">
<link rel="preload" href="/assets/js/main.43ba5e83.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/xks/">Xenit Kubernetes Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design">Architecture and design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/xks/developer-guide/introduction">Developer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/">Operator Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/agents">Agents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blast-radius">Blast Radius</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/blue-green">Blue Green Clusters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/aws-azdo">AWS azure-devops</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/github">XKF on Github</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/cve">CVE Information</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/kubernetes/aks">Kubernetes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/operator-guide/kubernetes/aks">AKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/operator-guide/kubernetes/eks">EKS</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/xenit-style-guide/containers">Xenit Style Guide</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AKS</h1></header><h2 class="anchor anchorWithStickyNavbar_mojV" id="system-node-pool">System Node Pool<a class="hash-link" href="#system-node-pool" title="Direct link to heading">â€‹</a></h2><p>AKS requires the configuration of a system node pool when creating a cluster. This system node pool is not like the other additional node pools. It is tightly coupled to the AKS cluster. It is not
possible without manual intervention to change the instance type or taints on this node pool without recreating the cluster. Additionally the system node pool cannot scale down to zero, for AKS to
work there has to be at least one instance present. This is because critical system pods like Tunnelfront and CoreDNS will by default run on the system node pool. For more information about AKS
system node pool refer to the <a href="https://docs.microsoft.com/en-us/azure/aks/use-system-pools#system-and-user-node-pools" target="_blank" rel="noopener noreferrer">official documentation</a>.</p><p>XKS follows the Azure recommendation and runs only system critical applications on the system node pool. Doing this protects services like CoreDNS from starvation or memory issues caused by user
applications running on the same nodes. This is achieved by adding the taint <code>CriticalAddonsOnly</code> to all of the system nodes.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="sizing-nodes">Sizing Nodes<a class="hash-link" href="#sizing-nodes" title="Direct link to heading">â€‹</a></h3><p>Smaller AKS clusters can survive with a single node as the load on the system applications will be moderately low. In larger clusters and production clusters it is recommended to run at least three
system nodes that may be larger in size. This section aims to describe how to properly size the system nodes.</p><p>The minimum requirement for a system node is a VM with at least 2 vCPUs and 4GB of memory. Burstable B series VMs are not recommended. A good starting point for all clusters are the D series node
types which have a balance of CPU and memory resources. A good starting point is a node of type <code>Standard_D2as_v4</code>.</p><p>More work has to be done in this area regarding sizing and scaling of the system node pools to achieve a standardized solution.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="modifying-nodes">Modifying Nodes<a class="hash-link" href="#modifying-nodes" title="Direct link to heading">â€‹</a></h3><p>There may come times when Terraform wants to recreate the AKS cluster when the system node pool has been updated. This happens when updating certain properties in the system node pool. It is still
possible to do these updates without recreating the cluster, but it requires some manual intervention. AKS requires at least one system node pool but does not have an upper limit. This makes it
possible to manually add a new temporary system node pool. Remove the existing default node pool created by Terraform. Create a new system node pool with the same name but with the updated parameters.
Finally remove the temporary node pool. Terraform will just assume that the changes have already been applied and import the new state without any other complaints.</p><p>Start off with creating a temporary system pool. Make sure to replace the cluster name and resource groups to the correct values.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name temp --mode </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;System&quot;</span><span class="token plain"> --node-count </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>It may not be possible to create a new node pool with the current Kubernetes version if the cluster has not been updated in a while. Azure will remove minor versions as new versions are released. In
that case you will need to upgrade the cluster to the latest minor version before making changes to the system pool, as AKS will not allow a node with a newer version than the control plane.</p></blockquote><p>Delete the system node pool created by Terraform:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool delete --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Create a new node pool with the new configuration. In this case it is setting a new instance type and adding a taint:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name default --mode </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;System&quot;</span><span class="token plain"> --zones </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> --node-vm-size </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Standard_D2as_v4&quot;</span><span class="token plain"> --node-taints </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;CriticalAddonsOnly=true:NoSchedule&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--node-count </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Delete the temporary pool:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool delete --cluster-name aks-dev-we-aks1 --resource-group rg-dev-we-aks --name temp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For additional information about updating the system nodes refer to <a href="https://pumpingco.de/blog/modify-aks-default-node-pool-in-terraform-without-redeploying-the-cluster/" target="_blank" rel="noopener noreferrer">this blog post</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="update-aks-cluster">Update AKS cluster<a class="hash-link" href="#update-aks-cluster" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="useful-commands-in-kubernetes">Useful commands in Kubernetes<a class="hash-link" href="#useful-commands-in-kubernetes" title="Direct link to heading">â€‹</a></h3><p>When patching an AKS cluster or just upgrading nodes it can be useful to watch your resources in Kubernetes.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Show node version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get nodes -o </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">jsonpath</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;{range .items[*]}{.metadata.name}{&quot;</span><span class="token string entity" style="color:rgb(195, 232, 141)">\t</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;}{.metadata.labels.kubernetes\.azure\.com\/node-image-version}{&quot;</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;}{end}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Watch nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">watch</span><span class="token plain"> kubectl get nodes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Check the status of all pods in the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get pods -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-update-kubernetes-version">Terraform update Kubernetes version<a class="hash-link" href="#terraform-update-kubernetes-version" title="Direct link to heading">â€‹</a></h3><p>TBD</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cli-update-kubernetes-version">CLI update Kubernetes version<a class="hash-link" href="#cli-update-kubernetes-version" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">RG</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">rg1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">POOL_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CLUSTER_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AZURE_LOCATION</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">westeurope</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">KUBE_VERSION</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1.21</span><span class="token plain">.9</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>What AKS versions can I pick in this Azure location:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks get-versions --location </span><span class="token variable" style="color:rgb(191, 199, 213)">$AZURE_LOCATION</span><span class="token plain"> -o table</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks get-upgrades --resource-group </span><span class="token variable" style="color:rgb(191, 199, 213)">$RG</span><span class="token plain"> --name </span><span class="token variable" style="color:rgb(191, 199, 213)">$CLUSTER_NAME</span><span class="token plain"> --output table</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We recommend to only upgrade control-plane separately and then upgrade the nodes.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks upgrade --resource-group </span><span class="token variable" style="color:rgb(191, 199, 213)">$RG</span><span class="token plain"> --name </span><span class="token variable" style="color:rgb(191, 199, 213)">$CLUSTER_NAME</span><span class="token plain"> --kubernetes-version </span><span class="token variable" style="color:rgb(191, 199, 213)">$KUBE_VERSION</span><span class="token plain"> --control-plane-only</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool upgrade --resource-group </span><span class="token variable" style="color:rgb(191, 199, 213)">$RG</span><span class="token plain"> --cluster-name </span><span class="token variable" style="color:rgb(191, 199, 213)">$CLUSTER_NAME</span><span class="token plain"> --name </span><span class="token variable" style="color:rgb(191, 199, 213)">$POOL_NAME</span><span class="token plain"> --kubernetes-version </span><span class="token variable" style="color:rgb(191, 199, 213)">$KUBE_VERSION</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="upgrading-node-pools-without-upgrading-cluster">Upgrading node pools without upgrading cluster<a class="hash-link" href="#upgrading-node-pools-without-upgrading-cluster" title="Direct link to heading">â€‹</a></h3><p>From time to time you might want to upgrade your Node Pools without upgrading the Kubernetes version. We always recommend to look at
the <a href="https://docs.microsoft.com/en-us/azure/aks/node-image-upgrade" target="_blank" rel="noopener noreferrer">official documentation</a>as well.</p><p>The node pool will spin up a new node and drain the existing one.
When this is done the old node will be deleted.</p><p>The below command works great for smaller clusters. If you want to upgrade more nodes faster it is possible to do so. Read the documentation for more information.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">RG</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">rg1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">POOL_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CLUSTER_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">cluster1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Get the latest available node versions for your node pool:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool get-upgrades --nodepool-name </span><span class="token variable" style="color:rgb(191, 199, 213)">$POOL_NAME</span><span class="token plain"> --cluster-name </span><span class="token variable" style="color:rgb(191, 199, 213)">$CLUSTER_NAME</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(191, 199, 213)">$RG</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Upgrade the image on the specified node pool:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az aks nodepool upgrade --resource-group </span><span class="token variable" style="color:rgb(191, 199, 213)">$RG</span><span class="token plain"> --cluster-name </span><span class="token variable" style="color:rgb(191, 199, 213)">$CLUSTER_NAME</span><span class="token plain"> --name </span><span class="token variable" style="color:rgb(191, 199, 213)">$POOL_NAME</span><span class="token plain"> --node-image-only</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="change-vm-size-through-terraform">Change vm size through Terraform<a class="hash-link" href="#change-vm-size-through-terraform" title="Direct link to heading">â€‹</a></h2><p>If you want to use terraform to change the your node pools VM size you <strong>can&#x27;t</strong> just change the vm_size in the additional_node_pools config.
This will tell Azure to drain all the nodes and then delete the existing ones, then Azure will spin up a new node pool after the existing one is gone.</p><p>This might be fine if you already have multiple additional node pools and you pods don&#x27;t have specific node affinities.</p><p>But if that isn&#x27;t the case terraform will most likely run for ever since it won&#x27;t be able to destroy the nodes that you already have workload on.
Or even worse it will destroy the existing node and you won&#x27;t have any node pools in your cluster to manage your workloads.</p><p>Instead you have to add a second additional node pool in to your cluster.</p><p>For example:</p><div class="codeBlockContainer_I0IT language-.hcl theme-code-block"><div class="codeBlockContent_wNvx .hcl"><pre tabindex="0" class="prism-code language-.hcl codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  additional_node_pools = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name                 = &quot;standard&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      orchestrator_version = &quot;1.21.2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      vm_size              = &quot;Standard_E2s_v4&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      min_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      max_count            = 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_labels          = {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_taints          = []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      spot_enabled         = false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      spot_max_price       = null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name                 = &quot;standard2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      orchestrator_version = &quot;1.21.2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      vm_size              = &quot;Standard_F4s_v2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      min_count            = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      max_count            = 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_labels          = {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      node_taints          = []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      spot_enabled         = false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      spot_max_price       = null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run terraform and see that standard2 is up and running.</p><p>Now you can remove the standard node pool and standard2 should be able to handle the new load.</p><p>Azure will automatically drain all the data from the old standard node pool.</p><p>Remember to set min_count so that your current workload fits, you can always reduce min_count later.
The cluster autoscaler will scale up new vm:s of standard2 but it will take time.
During the creation of more standard2 nodes much of your workload might become pending.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aks-resources">AKS resources<a class="hash-link" href="#aks-resources" title="Direct link to heading">â€‹</a></h2><p>To get a quick overview of what is happening in AKS you can look at its <a href="https://github.com/Azure/AKS/releases" target="_blank" rel="noopener noreferrer">changelog</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vmss-inject-commands">VMSS inject commands<a class="hash-link" href="#vmss-inject-commands" title="Direct link to heading">â€‹</a></h2><p>In Azure you can inject commands to VMSS instances using the <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command" target="_blank" rel="noopener noreferrer">Azure Linux VM agent</a>.</p><p>All you need to do is to get the RG of the VMSS, the node pool name and the instance ID.
You can find the instance ID by running <code>az vmss list-instances -g rg1 -n nodepool1</code> and look for <code>instanceId</code>.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">az vmss run-command invoke -g </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">RG</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> -n </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">node-pool-name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --command-id RunShellScript --instance-id </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">instance id</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">  --scripts </span><span class="token string" style="color:rgb(195, 232, 141)">&quot; nc -vz mcr.microsoft.com 443 &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">az vmss run-command invoke -g rg1 -n nodepool1 --command-id RunShellScript --instance-id </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">  --scripts </span><span class="token string" style="color:rgb(195, 232, 141)">&quot; nc -vz mcr.microsoft.com 443 &quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/kubernetes/aks.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xks/operator-guide/cve"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">CVE Information</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/xks/operator-guide/kubernetes/eks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EKS</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-node-pool" class="table-of-contents__link toc-highlight">System Node Pool</a><ul><li><a href="#sizing-nodes" class="table-of-contents__link toc-highlight">Sizing Nodes</a></li><li><a href="#modifying-nodes" class="table-of-contents__link toc-highlight">Modifying Nodes</a></li></ul></li><li><a href="#update-aks-cluster" class="table-of-contents__link toc-highlight">Update AKS cluster</a><ul><li><a href="#useful-commands-in-kubernetes" class="table-of-contents__link toc-highlight">Useful commands in Kubernetes</a></li><li><a href="#terraform-update-kubernetes-version" class="table-of-contents__link toc-highlight">Terraform update Kubernetes version</a></li><li><a href="#cli-update-kubernetes-version" class="table-of-contents__link toc-highlight">CLI update Kubernetes version</a></li><li><a href="#upgrading-node-pools-without-upgrading-cluster" class="table-of-contents__link toc-highlight">Upgrading node pools without upgrading cluster</a></li></ul></li><li><a href="#change-vm-size-through-terraform" class="table-of-contents__link toc-highlight">Change vm size through Terraform</a></li><li><a href="#aks-resources" class="table-of-contents__link toc-highlight">AKS resources</a></li><li><a href="#vmss-inject-commands" class="table-of-contents__link toc-highlight">VMSS inject commands</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.2c69eb5d.js"></script>
<script src="/assets/js/main.43ba5e83.js"></script>
</body>
</html>