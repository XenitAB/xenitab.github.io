<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><title data-react-helmet="true">Profiling Go in Kubernetes | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Profiling Go in Kubernetes | Xenit"><meta data-react-helmet="true" name="description" content="Profiling Go in Kubernetes using Kubernetes debug."><meta data-react-helmet="true" property="og:description" content="Profiling Go in Kubernetes using Kubernetes debug."><meta data-react-helmet="true" name="keywords" content="pprof,kubernetes,debug"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-11-21T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/nissessenap"><meta data-react-helmet="true" property="article:tag" content="pprof,kubernetes,debug"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.018923a1.css">
<link rel="preload" href="/assets/js/runtime~main.5a5da298.js" as="script">
<link rel="preload" href="/assets/js/main.792b68e3.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/2022/11/21/golang-memory-dump">Profiling Go in Kubernetes</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/05/04/starboard">Improving XKS security using Starboard</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/04/25/designing-restful-apis-for-cloud-services">Designing RESTful APIs for cloud services</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/04/12/ephemeral-container-security">Kubernetes Ephemeral Container Security</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/02/23/12factor">Twelve-factor app anno 2022</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Profiling Go in Kubernetes</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-11-21T00:00:00.000Z" itemprop="datePublished">November 21, 2022</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/nissessenap" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://media-exp1.licdn.com/dms/image/C5603AQEtMiyg5yOAqQ/profile-displayphoto-shrink_800_800/0/1580133585786?e=1673481600&amp;v=beta&amp;t=SXFrHWYPkM2jpaKESqhdVIQix65MQP1slsoTBXGOmrY" alt="Edvin Norling"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/nissessenap" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Edvin Norling</span></a></div><small class="avatar__subtitle" itemprop="description">Expert DevOps Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>In Kubernetes 1.23 the new ephemeral containers API went in to beta and in 1.25 it became stable.
Ephemeral containers or debug containers as it is also known as, makes it&#x27;s possible to inject a container into an already running pod without restarting it.
This is very useful when you want to debug your application since the ephemeral container can provide tools that you don&#x27;t want in your application container.</p><p>In this post I thought we could go trough how to profile a running container in Kubernetes.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="application">Application<a class="hash-link" href="#application" title="Direct link to heading">â€‹</a></h2><p>To get started lets use a very simple test <a href="https://github.com/polarsignals/pprof-example-app-go" target="_blank" rel="noopener noreferrer">application</a> written by the team over at <a href="https://www.polarsignals.com/" target="_blank" rel="noopener noreferrer">Polar Signals</a>.</p><p>They have been kind enough to publish a container image and a Kubernetes deployment that we will use.
The application is built in such a way that it will continue to use memory and the Kubernetes yaml don&#x27;t contain any request nor limit so don&#x27;t run this for a long time or your system will probably OOM.</p><p>Run the application on Kubernetes 1.23 or higher.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/polarsignals/pprof-example-app-go/main/manifests/deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For starters lets have a look at the pprof http endpoint using curl.
A simple way of doing so is to create a Kubernetes service and reach the pod from another container.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Expose the pprof deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl expose deployment pprof-example-app-go --port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">8080</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Create a curl pod and look at the data inside our app.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl run -i -t </span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> --image</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">curlimages/curl:latest /bin/sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You will be sent directly in to the container and you can run something like:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> http://pprof-example-app-go:8080/debug/pprof/allocs?debug</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will show you an output that look something like this:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">heap profile: </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">47357952</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">5473</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">554303632</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> @ heap/1048576</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">46882816</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">46882816</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> @ 0x697585 0x470ce1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#   0x697584    main.allocMem+0xa4  /home/brancz/src/github.com/polarsignals/pprof-example-app-go/main.go:65</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">212992</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">212992</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> @ 0x4e3b6e 0x4e3e6c 0x6974c5 0x470ce1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#   0x4e3b6d    log.(*Logger).Output+0x38d  /usr/local/go/src/log/log.go:180</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#   0x4e3e6b    log.Println+0x6b        /usr/local/go/src/log/log.go:329</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#   0x6974c4    main.calculateFib+0xc4      /home/brancz/src/github.com/polarsignals/pprof-example-app-go/main.go:55</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">204800</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: </span><span class="token number" style="color:rgb(247, 140, 108)">204800</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> @ 0x4fb68f 0x4fb256 0x503d3d 0x502c97 0x4f6d5e 0x4f6c92 0x4d22a5 0x4d2625 0x4d70b1 0x4cf3d2 0x4e3e3f 0x6974c5 0x470ce1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#   0x4fb68e    math/big.nat.make+0x5ee     /usr/local/go/src/math/big/nat.go:69</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#   0x4fb255    math/big.nat.sqr+0x1b5      /usr/local/go/src/math/big/nat.go:595</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sadly this output isn&#x27;t the easiest to read so why not use pprof and while we are at it why not use ephemeral containers.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="debug-containerephemeral-container">Debug container/ephemeral container<a class="hash-link" href="#debug-containerephemeral-container" title="Direct link to heading">â€‹</a></h2><p>My original plan for this blog post was to attach a new volume to the ephemeral container so we could save data locally and then copy it out to our client and show some nice flame graphs. But apparently it&#x27;s not supported to attach volumes to the ephemeral container.
The ephemeral container cannot even reach the existing volumes on the pod you attach to.</p><p>There is an open <a href="https://github.com/kubernetes/kubectl/issues/1071" target="_blank" rel="noopener noreferrer">issue</a> to solve this but it&#x27;s not part of the current enhancement <a href="https://github.com/kubernetes/enhancements/issues/1441" target="_blank" rel="noopener noreferrer">proposal</a> so this is nothing that we will see in the near future.</p><p>So instead I will just show how we can debug using pprof from within the container.
Since we exposed the endpoint through a service we could of course do this from another pod as well.
But in general you should be very restrictive of what traffic that can reach your pprof endpoint if you expose it at all.</p><p>So finally time to use the <code>kubectl debug</code> command.</p><p>The debug command is used on a specific pod, in my case it&#x27;s <code>pprof-example-app-go-7c4b6d77d-xw52p</code>.
Let&#x27;s attach a standard golang container to our running pod, in this case i choose golang 1.15 to match the pprof tool with the running application.</p><p>Kubernetes will attach the container for you and give you a shell.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl debug -i -t pprof-example-app-go-7c4b6d77d-xw52p --image</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">golang:1.15-alpine3.14 -- /bin/sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we can point on localhost using pprof.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">go tool pprof http://localhost:8080/debug/pprof/allocs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will provide you with a pprof terminal inside the container.</p><p>I&#x27;m no pprof pro but there are some easy commands to get you started.
<code>top 10 -cum</code> will show you the resource consumption it takes to call a function including all function it calls</p><div class="codeBlockContainer_I0IT language-pprof theme-code-block"><div class="codeBlockContent_wNvx pprof"><pre tabindex="0" class="prism-code language-pprof codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">top 10 -cum</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing nodes accounting for 27.63GB, 99.80% of 27.69GB total</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dropped 26 nodes (cum &lt;= 0.14GB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing top 10 nodes out of 17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0%     0%    25.66GB 92.69%  main.calculateFib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   25.59GB 92.43% 92.43%    25.59GB 92.43%  math/big.nat.make (inline)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 92.43%    25.41GB 91.78%  github.com/polarsignals/pprof-example-app-go/fib.Fibonacci</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 92.43%    25.41GB 91.78%  math/big.(*Int).Add</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 92.43%    25.41GB 91.78%  math/big.nat.add</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    2.02GB  7.30% 99.73%     2.02GB  7.30%  main.allocMem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    0.02GB 0.073% 99.80%     0.25GB  0.91%  fmt.Sprintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.80%     0.25GB  0.91%  log.Println</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.80%     0.23GB  0.84%  fmt.(*pp).doPrintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.80%     0.23GB  0.84%  fmt.(*pp).handleMethods</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>top 10 -flat</code> will show you the resource consumption it takes to call a function excluding all function it calls</p><div class="codeBlockContainer_I0IT language-pprof theme-code-block"><div class="codeBlockContent_wNvx pprof"><pre tabindex="0" class="prism-code language-pprof codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active filters:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   ignore=flat</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing nodes accounting for 27.66GB, 99.90% of 27.69GB total</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dropped 10 nodes (cum &lt;= 0.14GB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing top 10 nodes out of 17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   25.59GB 92.43% 92.43%    25.59GB 92.43%  math/big.nat.make (inline)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    2.02GB  7.30% 99.73%     2.02GB  7.30%  main.allocMem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    0.03GB   0.1% 99.83%     0.21GB  0.76%  math/big.nat.itoa</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    0.02GB 0.073% 99.90%     0.25GB  0.91%  fmt.Sprintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).doPrintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).handleMethods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).printArg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%    25.41GB 91.78%  github.com/polarsignals/pprof-example-app-go/fib.Fibonacci</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.25GB  0.91%  log.Println</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%    25.66GB 92.69%  main.calculateFib</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>By looking at the output we can see that it&#x27;s <code>math/big.nat.make</code> that takes the most resources.</p><p>Just for fun I also generated a flame graph using pprof by port-forwarding to the application and running</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">go tool pprof -http</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">: http://localhost:8080/debug/pprof/allocs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><img alt="pprof flame" src="/img/assets/blog/pprof_flame.png"><h2 class="anchor anchorWithStickyNavbar_mojV" id="cleanup">Cleanup<a class="hash-link" href="#cleanup" title="Direct link to heading">â€‹</a></h2><p>To cleanup the resources we created run:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete -f https://raw.githubusercontent.com/polarsignals/pprof-example-app-go/main/manifests/deployment.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete svc pprof-example-app-go</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete pod </span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">â€‹</a></h2><p>The <code>kubectl debug</code> command is extremely useful when you want to debug your application and you
don&#x27;t have access to a shell or the tools that you need in your normal container.</p><p>It saves us from having to install unneeded applications in our container which lowers the amount of potential CVE:s and the time it takes to start your container by lower container size.
Kubectl debug isn&#x27;t perfect and it won&#x27;t work for all your uses cases especially since you can&#x27;t use it to interact with existing volumes but it&#x27;s a great start.</p><p>When it comes to continues profiling it&#x27;s probably better to look at tool specifically written for it like <a href="https://grafana.com/oss/phlare/" target="_blank" rel="noopener noreferrer">Grafana Phlare</a> or <a href="https://www.parca.dev/docs/overview" target="_blank" rel="noopener noreferrer">Parca</a>.
But using a tool like pprof locally can be a good start. Hopefully we will get time to write a blog about continues profiling in the future.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/pprof">pprof</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/debug">debug</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/05/04/starboard"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Improving XKS security using Starboard</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#application" class="table-of-contents__link toc-highlight">Application</a></li><li><a href="#debug-containerephemeral-container" class="table-of-contents__link toc-highlight">Debug container/ephemeral container</a></li><li><a href="#cleanup" class="table-of-contents__link toc-highlight">Cleanup</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.5a5da298.js"></script>
<script src="/assets/js/main.792b68e3.js"></script>
</body>
</html>