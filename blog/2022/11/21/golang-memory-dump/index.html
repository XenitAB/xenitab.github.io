<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Profiling Go in Kubernetes | Xenit</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-rh="true" name="twitter:image" content="http://xenitab.github.io/img/Xenit_logo_Svart.png"><meta data-rh="true" property="og:url" content="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Profiling Go in Kubernetes | Xenit"><meta data-rh="true" name="description" content="Profiling Go in Kubernetes using Kubernetes debug."><meta data-rh="true" property="og:description" content="Profiling Go in Kubernetes using Kubernetes debug."><meta data-rh="true" name="keywords" content="pprof,kubernetes,debug"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-21T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/nissessenap"><meta data-rh="true" property="article:tag" content="pprof,kubernetes,debug"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump"><link data-rh="true" rel="alternate" href="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump" hreflang="en"><link data-rh="true" rel="alternate" href="http://xenitab.github.io/blog/2022/11/21/golang-memory-dump" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"http://xenitab.github.io/blog/2022/11/21/golang-memory-dump","mainEntityOfPage":"http://xenitab.github.io/blog/2022/11/21/golang-memory-dump","url":"http://xenitab.github.io/blog/2022/11/21/golang-memory-dump","headline":"Profiling Go in Kubernetes","name":"Profiling Go in Kubernetes","description":"Profiling Go in Kubernetes using Kubernetes debug.","datePublished":"2022-11-21T00:00:00.000Z","author":{"@type":"Person","name":"Edvin Norling","description":"Expert DevOps Engineer","url":"https://github.com/nissessenap","email":"edvin.norling@xenit.se","image":"https://media-exp1.licdn.com/dms/image/C5603AQEtMiyg5yOAqQ/profile-displayphoto-shrink_800_800/0/1580133585786?e=1673481600&v=beta&t=SXFrHWYPkM2jpaKESqhdVIQix65MQP1slsoTBXGOmrY"},"keywords":["pprof","kubernetes","debug"],"isPartOf":{"@type":"Blog","@id":"http://xenitab.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Xenit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Xenit Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5K3TQ3K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-5K3TQ3K",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.835dd407.css">
<script src="/assets/js/runtime~main.b2f95f14.js" defer="defer"></script>
<script src="/assets/js/main.50de46a3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2022/11/21/golang-memory-dump">Profiling Go in Kubernetes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/05/04/starboard">Improving XKS security using Starboard</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/25/designing-restful-apis-for-cloud-services">Designing RESTful APIs for cloud services</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/12/ephemeral-container-security">Kubernetes Ephemeral Container Security</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/02/23/12factor">Twelve-factor app anno 2022</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Profiling Go in Kubernetes</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-11-21T00:00:00.000Z">November 21, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/nissessenap" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://media-exp1.licdn.com/dms/image/C5603AQEtMiyg5yOAqQ/profile-displayphoto-shrink_800_800/0/1580133585786?e=1673481600&amp;v=beta&amp;t=SXFrHWYPkM2jpaKESqhdVIQix65MQP1slsoTBXGOmrY" alt="Edvin Norling"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/nissessenap" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">Edvin Norling</span></a></div><small class="authorTitle_nd0D" title="Expert DevOps Engineer">Expert DevOps Engineer</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>In Kubernetes 1.23 the new ephemeral containers API went in to beta and in 1.25 it became stable.
Ephemeral containers or debug containers as it is also known as, makes it&#x27;s possible to inject a container into an already running pod without restarting it.
This is very useful when you want to debug your application since the ephemeral container can provide tools that you don&#x27;t want in your application container.</p>
<p>In this post I thought we could go trough how to profile a running container in Kubernetes.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="application">Application<a href="#application" class="hash-link" aria-label="Direct link to Application" title="Direct link to Application" translate="no">​</a></h2>
<p>To get started lets use a very simple test <a href="https://github.com/polarsignals/pprof-example-app-go" target="_blank" rel="noopener noreferrer" class="">application</a> written by the team over at <a href="https://www.polarsignals.com/" target="_blank" rel="noopener noreferrer" class="">Polar Signals</a>.</p>
<p>They have been kind enough to publish a container image and a Kubernetes deployment that we will use.
The application is built in such a way that it will continue to use memory and the Kubernetes yaml don&#x27;t contain any request nor limit so don&#x27;t run this for a long time or your system will probably OOM.</p>
<p>Run the application on Kubernetes 1.23 or higher.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/polarsignals/pprof-example-app-go/main/manifests/deployment.yaml</span><br></span></code></pre></div></div>
<p>For starters lets have a look at the pprof http endpoint using curl.
A simple way of doing so is to create a Kubernetes service and reach the pod from another container.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Expose the pprof deployment</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl expose deployment pprof-example-app-go --port=8080</span><br></span></code></pre></div></div>
<p>Create a curl pod and look at the data inside our app.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl run -i -t curl --image=curlimages/curl:latest /bin/sh</span><br></span></code></pre></div></div>
<p>You will be sent directly in to the container and you can run something like:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl http://pprof-example-app-go:8080/debug/pprof/allocs?debug=1</span><br></span></code></pre></div></div>
<p>This will show you an output that look something like this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">heap profile: 4: 47357952 [5473: 554303632] @ heap/1048576</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: 46882816 [1: 46882816] @ 0x697585 0x470ce1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#	0x697584	main.allocMem+0xa4	/home/brancz/src/github.com/polarsignals/pprof-example-app-go/main.go:65</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: 212992 [1: 212992] @ 0x4e3b6e 0x4e3e6c 0x6974c5 0x470ce1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#	0x4e3b6d	log.(*Logger).Output+0x38d	/usr/local/go/src/log/log.go:180</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#	0x4e3e6b	log.Println+0x6b		/usr/local/go/src/log/log.go:329</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#	0x6974c4	main.calculateFib+0xc4		/home/brancz/src/github.com/polarsignals/pprof-example-app-go/main.go:55</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: 204800 [1: 204800] @ 0x4fb68f 0x4fb256 0x503d3d 0x502c97 0x4f6d5e 0x4f6c92 0x4d22a5 0x4d2625 0x4d70b1 0x4cf3d2 0x4e3e3f 0x6974c5 0x470ce1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#	0x4fb68e	math/big.nat.make+0x5ee		/usr/local/go/src/math/big/nat.go:69</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#	0x4fb255	math/big.nat.sqr+0x1b5		/usr/local/go/src/math/big/nat.go:595</span><br></span></code></pre></div></div>
<p>Sadly this output isn&#x27;t the easiest to read so why not use pprof and while we are at it why not use ephemeral containers.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="debug-containerephemeral-container">Debug container/ephemeral container<a href="#debug-containerephemeral-container" class="hash-link" aria-label="Direct link to Debug container/ephemeral container" title="Direct link to Debug container/ephemeral container" translate="no">​</a></h2>
<p>My original plan for this blog post was to attach a new volume to the ephemeral container so we could save data locally and then copy it out to our client and show some nice flame graphs. But apparently it&#x27;s not supported to attach volumes to the ephemeral container.
The ephemeral container cannot even reach the existing volumes on the pod you attach to.</p>
<p>There is an open <a href="https://github.com/kubernetes/kubectl/issues/1071" target="_blank" rel="noopener noreferrer" class="">issue</a> to solve this but it&#x27;s not part of the current enhancement <a href="https://github.com/kubernetes/enhancements/issues/1441" target="_blank" rel="noopener noreferrer" class="">proposal</a> so this is nothing that we will see in the near future.</p>
<p>So instead I will just show how we can debug using pprof from within the container.
Since we exposed the endpoint through a service we could of course do this from another pod as well.
But in general you should be very restrictive of what traffic that can reach your pprof endpoint if you expose it at all.</p>
<p>So finally time to use the <code>kubectl debug</code> command.</p>
<p>The debug command is used on a specific pod, in my case it&#x27;s <code>pprof-example-app-go-7c4b6d77d-xw52p</code>.
Let&#x27;s attach a standard golang container to our running pod, in this case i choose golang 1.15 to match the pprof tool with the running application.</p>
<p>Kubernetes will attach the container for you and give you a shell.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl debug -i -t pprof-example-app-go-7c4b6d77d-xw52p --image=golang:1.15-alpine3.14 -- /bin/sh</span><br></span></code></pre></div></div>
<p>Now we can point on localhost using pprof.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">go tool pprof http://localhost:8080/debug/pprof/allocs</span><br></span></code></pre></div></div>
<p>This will provide you with a pprof terminal inside the container.</p>
<p>I&#x27;m no pprof pro but there are some easy commands to get you started.
<code>top 10 -cum</code> will show you the resource consumption it takes to call a function including all function it calls</p>
<div class="language-pprof codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pprof codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">top 10 -cum</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing nodes accounting for 27.63GB, 99.80% of 27.69GB total</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dropped 26 nodes (cum &lt;= 0.14GB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing top 10 nodes out of 17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0%     0%    25.66GB 92.69%  main.calculateFib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   25.59GB 92.43% 92.43%    25.59GB 92.43%  math/big.nat.make (inline)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 92.43%    25.41GB 91.78%  github.com/polarsignals/pprof-example-app-go/fib.Fibonacci</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 92.43%    25.41GB 91.78%  math/big.(*Int).Add</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 92.43%    25.41GB 91.78%  math/big.nat.add</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    2.02GB  7.30% 99.73%     2.02GB  7.30%  main.allocMem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    0.02GB 0.073% 99.80%     0.25GB  0.91%  fmt.Sprintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.80%     0.25GB  0.91%  log.Println</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.80%     0.23GB  0.84%  fmt.(*pp).doPrintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.80%     0.23GB  0.84%  fmt.(*pp).handleMethods</span><br></span></code></pre></div></div>
<p><code>top 10 -flat</code> will show you the resource consumption it takes to call a function excluding all function it calls</p>
<div class="language-pprof codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pprof codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active filters:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   ignore=flat</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing nodes accounting for 27.66GB, 99.90% of 27.69GB total</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dropped 10 nodes (cum &lt;= 0.14GB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Showing top 10 nodes out of 17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   25.59GB 92.43% 92.43%    25.59GB 92.43%  math/big.nat.make (inline)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    2.02GB  7.30% 99.73%     2.02GB  7.30%  main.allocMem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    0.03GB   0.1% 99.83%     0.21GB  0.76%  math/big.nat.itoa</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    0.02GB 0.073% 99.90%     0.25GB  0.91%  fmt.Sprintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).doPrintln</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).handleMethods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.23GB  0.84%  fmt.(*pp).printArg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%    25.41GB 91.78%  github.com/polarsignals/pprof-example-app-go/fib.Fibonacci</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%     0.25GB  0.91%  log.Println</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         0     0% 99.90%    25.66GB 92.69%  main.calculateFib</span><br></span></code></pre></div></div>
<p>By looking at the output we can see that it&#x27;s <code>math/big.nat.make</code> that takes the most resources.</p>
<p>Just for fun I also generated a flame graph using pprof by port-forwarding to the application and running</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">go tool pprof -http=: http://localhost:8080/debug/pprof/allocs</span><br></span></code></pre></div></div>
<img alt="pprof flame" src="/img/assets/blog/pprof_flame.png">
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cleanup">Cleanup<a href="#cleanup" class="hash-link" aria-label="Direct link to Cleanup" title="Direct link to Cleanup" translate="no">​</a></h2>
<p>To cleanup the resources we created run:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete -f https://raw.githubusercontent.com/polarsignals/pprof-example-app-go/main/manifests/deployment.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete svc pprof-example-app-go</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete pod curl</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>The <code>kubectl debug</code> command is extremely useful when you want to debug your application and you
don&#x27;t have access to a shell or the tools that you need in your normal container.</p>
<p>It saves us from having to install unneeded applications in our container which lowers the amount of potential CVE<!-- -->:s<!-- --> and the time it takes to start your container by lower container size.
Kubectl debug isn&#x27;t perfect and it won&#x27;t work for all your uses cases especially since you can&#x27;t use it to interact with existing volumes but it&#x27;s a great start.</p>
<p>When it comes to continues profiling it&#x27;s probably better to look at tool specifically written for it like <a href="https://grafana.com/oss/phlare/" target="_blank" rel="noopener noreferrer" class="">Grafana Phlare</a> or <a href="https://www.parca.dev/docs/overview" target="_blank" rel="noopener noreferrer" class="">Parca</a>.
But using a tool like pprof locally can be a good start. Hopefully we will get time to write a blog about continues profiling in the future.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/pprof">pprof</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/debug">debug</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2022/05/04/starboard"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Improving XKS security using Starboard</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#application" class="table-of-contents__link toc-highlight">Application</a></li><li><a href="#debug-containerephemeral-container" class="table-of-contents__link toc-highlight">Debug container/ephemeral container</a></li><li><a href="#cleanup" class="table-of-contents__link toc-highlight">Cleanup</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div></div>
</body>
</html>